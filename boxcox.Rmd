---
title: "Box Cox Data Modelling"
author: "Jerry Wu"
date: "9/19/2023"
output:
  pdf_document: default
  html_document:
    df_print: paged
abstract: ''
subtitle: ''
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
library(tidyverse)
library(mgcv)
library(mgcViz)
library(caret)
library(car)
library(xgboost)
library(ggpmisc)
library(GGally)
library(ggpubr)
select <- dplyr::select
```

```{r}
full_data <- readRDS('data/full_data.rds')
daily_full <- readRDS('data/daily_full.rds')
```

# Data setup
```{r}
# get train data set for daily average H2S
daily_avg_train_sincefeb2022 <- daily_full[complete.cases(daily_full),] %>% 
  filter(day >= '2022-02-01') %>%
  select(H2S_daily_avg, month, year, weekday, MinDist,
         wd_avg, ws_avg, daily_downwind_ref, capacity, dist_wrp, mon_utm_x, 
         mon_utm_y, day, monthly_oil_1km, monthly_gas_1km, active_1km, daily_downwind_wrp, 
         elevation, EVI, num_odor_complaints, dist_dc, avg_temp,  avg_hum, precip)
```

# Explore H2S concentration
```{r}
ggplot(daily_avg_train_sincefeb2022, aes(x = H2S_daily_avg)) +
  geom_histogram(fill = "salmon", col = "white")

ggplot(daily_avg_train_sincefeb2022, aes(x = H2S_daily_avg)) +
  geom_histogram(fill = "salmon", col = "white") + 
  scale_x_continuous(limits = c(0, 2.5))
```

# GAM
## Since Feb 2022
```{r}
# Since feb 2022
h2s_da_model_f <- gam(H2S_daily_avg~s(as.numeric(month),bs='cc') + year + as.character(weekday) +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                        te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        I(1/dist_dc^2) + avg_temp + avg_hum + precip, 
                      data = daily_avg_train_sincefeb2022)
summary(h2s_da_model_f)
plot(h2s_da_model_f)
```

### Condition 1
```{r}
# Check Condition 1
ggplot(tibble(obs = daily_avg_train_sincefeb2022$H2S_daily_avg, pred = fitted(h2s_da_model_f)),
                             aes(x = pred, y = obs)) +
                        geom_point() +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq", "R2", "n"))) +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Observed vs Predicted for Since 2022 GAM') +
                        theme_bw()
```

### Condition 2
```{r}
# Check condition 2
pair <- ggpairs(daily_avg_train_sincefeb2022, lower=list(continuous=ggally_points, combo=ggally_box_no_facet), upper=list(continuous = "blankDiag", discrete = "blankDiag", combo = "blankDiag"), diag=list(continuous = "blankDiag", discrete = "blankDiag", combo = "blankDiag"), axisLabels="show", cardinality_threshold = 55, progress = FALSE)
pair
```

### Residual Plots
```{r}
# Residual plots
rs_full <- h2s_da_model_f$residuals
plot(rs_full~fitted(h2s_da_model_f), xlab="Fitted", ylab="Residuals")
```
```{r}
par(mfrow=c(2,3))
for(i in c(2:3, 5:length(daily_avg_train_sincefeb2022))){
  print(i)
  plot(rs_full~unlist(daily_avg_train_sincefeb2022[,i]), xlab=names(daily_avg_train_sincefeb2022)[i], ylab="Residuals")
}
```

```{r}
# Normal Q-Q Plot
stats::qqnorm(rs_full, sub = "Since Feb 2022 before transformation")
stats::qqline(rs_full)
```

```{r}
stats::qqnorm(rs_full, sub = "Since Feb 2022 before transformation w.o zoomed in",
              ylim = c(-1, 2))
stats::qqline(rs_full)
```

# Box Cox Transformations Since Feb 2022
```{r}
# try transformations
# On both response and predictors
transform_all <- readRDS('rfiles/transform_all.rds')
#transform_all <- powerTransform(as.matrix(daily_avg_train_sincefeb2022 %>%
#                                            select(-c(month, day, year, weekday))), 
#                                family = "bcnPower")
#saveRDS(transform_all, 'rfiles/transform_all.rds')
summary(transform_all)

# On only predictors
transform_pred <- readRDS('rfiles/transform_pred.rds')
# transform_pred <- powerTransform(as.matrix(daily_avg_train_sincefeb2022 %>%
#                                              select(-c(month, day, year, weekday, 
#                                                        H2S_daily_avg))),
#                                  family = "bcnPower")
# saveRDS(transform_pred, 'rfiles/transform_pred.rds')
summary(transform_pred)

# On only response
transform_resp <- readRDS('rfiles/transform_resp.rds')
# transform_resp <- powerTransform(as.matrix(daily_avg_train_sincefeb2022 %>%
#                                              select(H2S_daily_avg)),
#                                  family = "bcnPower")
# saveRDS(transform_resp, 'rfiles/transform_resp.rds')
summary(transform_resp)
# This is quite similar to transforming both

# This suggests a 0.37 power transformation
```

## Tranformed Pred/Resp
```{r}
# Apply the suggested power transformations for transforming both predictor and outcome
# get train data set for daily average H2S
daily_avg_train_sincefeb2022_both_trans <- daily_avg_train_sincefeb2022 %>%
  mutate(H2S_daily_avg = H2S_daily_avg^0.33, 
         wd_avg = wd_avg^2.311, 
         ws_avg = ws_avg^-1.606,
         capacity = capacity^0.675, 
         dist_wrp = dist_wrp^0.192,
         MinDist = MinDist^-0.500,
         mon_utm_x = mon_utm_x^-1.521, 
         mon_utm_y = mon_utm_y^-0.895,
         monthly_oil_1km = log(monthly_oil_1km),
         monthly_gas_1km = monthly_gas_1km^-0.688,
         active_1km = active_1km^-3,
         elevation = elevation^-0.398,
         EVI = EVI^-1.675,
         num_odor_complaints = (num_odor_complaints + 1)^-3,
         avg_temp = avg_temp^-0.5,
         avg_hum = avg_hum^2.458,
         precip = (precip + 1)^-3,
         )
```

```{r}
ggplot(daily_avg_train_sincefeb2022_both_trans, aes(x = H2S_daily_avg)) +
  geom_histogram(fill = "salmon", col = "white")
```

```{r}
# Since feb 2022
h2s_da_model_f_trans <- gam(H2S_daily_avg~s(as.numeric(month),bs='cc') + year + as.character(weekday) +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          dist_wrp + MinDist +
                         s(mon_utm_x, mon_utm_y, bs='tp', k = 10) + 
                        te(mon_utm_x, mon_utm_y, as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        dist_dc + avg_temp + avg_hum + precip, 
                      data = daily_avg_train_sincefeb2022_both_trans)
summary(h2s_da_model_f_trans)
plot(h2s_da_model_f_trans)
```

## Tranformed Resp^0.37
```{r}
# Apply the suggested power transformations for transforming both predictor and outcome
# get train data set for daily average H2S
daily_avg_train_sincefeb2022_trans_resp <- daily_avg_train_sincefeb2022 %>%
  mutate(H2S_daily_avg = H2S_daily_avg^0.37)
```

```{r}
ggplot(daily_avg_train_sincefeb2022_trans_resp, aes(x = H2S_daily_avg)) +
  geom_histogram(fill = "salmon", col = "white")
```

```{r}
h2s_da_model_f_trans_resp <- gam(H2S_daily_avg~s(as.numeric(month),bs='cc') + year + as.character(weekday) +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                        te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        I(1/dist_dc^2) + avg_temp + avg_hum + precip, 
                      data = daily_avg_train_sincefeb2022_trans_resp)
summary(h2s_da_model_f_trans_resp)
plot(h2s_da_model_f_trans_resp)
```

## Tranformed log-Resp
```{r}
ggplot(daily_avg_train_sincefeb2022, aes(x = log(H2S_daily_avg+0.1))) +
  geom_histogram(fill = "salmon", col = "white")
```

```{r}
h2s_da_model_f_logresp <- gam(I(log(H2S_daily_avg + 0.1))~s(as.numeric(month),bs='cc') + year + as.character(weekday) +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                        te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        I(1/dist_dc^2) + avg_temp + avg_hum + precip, 
                      data = daily_avg_train_sincefeb2022)
summary(h2s_da_model_f_logresp)
plot(h2s_da_model_f_logresp)
```

### Condition 1
```{r}
# Check Condition 1
ggplot(tibble(obs = log(daily_avg_train_sincefeb2022$H2S_daily_avg + 0.1), pred = fitted(h2s_da_model_f_logresp)),
                             aes(x = pred, y = obs)) +
                        geom_point() +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq", "R2", "n"))) +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Observed vs Predicted with log(x+0.1) transformation') +
                        theme_bw()
```

### Residual Plots
```{r}
# Residual plots
rs_full <- h2s_da_model_f_logresp$residuals
plot(rs_full~fitted(h2s_da_model_f_logresp), xlab="Fitted", ylab="Residuals")
```


```{r}
# Normal Q-Q Plot
stats::qqnorm(rs_full, sub = "Since Feb 2022 after log transformation")
stats::qqline(rs_full)
```

# 10-fold CV
```{r}
adj_r2 <- function(r2, n, p){
  return(1 - (1-r2)*(n - 1)/(n - p - 1))
}
```

```{r}
set.seed(1)
random_seeds <- floor(runif(3, min=0, max=1)*100)
```

```{r}
result_10cv <- tibble(Model = character(),
                 '10CV AVG Train R-Sq' = numeric(),
                 '10CV AVG Test R-Sq' = numeric(),
                 'Test RMSE' = numeric())

validation_result_10cv <- tibble(Model = character(),
                            'Coef' = numeric(),
                            'R-Sq' = numeric())

# model 1: Log H2S
obs_10cv_log_trans <- c()
pred_10cv_log_trans <- c()
adj_r2_log_trans <- c()
adj_r2_test_log_trans <- c()

set.seed(random_seeds[1])
folds <- createFolds(seq(1, nrow(daily_avg_train_sincefeb2022)), k = 10)
  
for (fold in seq(1, 10)) {
  test <- daily_avg_train_sincefeb2022[folds[[fold]], ]
  train <- anti_join(daily_avg_train_sincefeb2022, test, by = join_by(dist_dc, day))
  
  h2s_da_model_10cv <- gam(I(log(H2S_daily_avg + 0.1))~s(as.numeric(month),bs='cc') + year + as.character(weekday) +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                        te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        I(1/dist_dc^2) + avg_temp + avg_hum + precip, 
                          data = train)

  predictions <- predict(h2s_da_model_10cv, newdata = test)
  r2_test <- R2(test$H2S_daily_avg, predictions)
  adj_r2_test <- adj_r2(r2_test, summary(h2s_da_model_10cv)$n, summary(h2s_da_model_10cv)$np)
  
  obs_10cv_log_trans <- append(obs_10cv_log_trans, test %>% pull(H2S_daily_avg))
  pred_10cv_log_trans <- append(pred_10cv_log_trans, predictions)
  adj_r2_log_trans <- append(adj_r2_log_trans, summary(h2s_da_model_10cv)$r.sq)
  adj_r2_test_log_trans <- append(adj_r2_test_log_trans, adj_r2_test)
}

result_10cv <- rbind(result_10cv, tibble(Model = 'Since Feb 2022 Log Transform',
                               '10CV AVG Train R-Sq' = mean(adj_r2_log_trans),
                               '10CV AVG Test R-Sq' = mean(adj_r2_test_log_trans),
                               'Test RMSE' = RMSE(pred_10cv_log_trans, obs_10cv_log_trans)))

log_h2s_10cv_obs_vs_pred_plot <- ggplot(tibble(obs = obs_10cv_log_trans, pred = pred_10cv_log_trans),
                             aes(x = pred, y = obs)) +
                        geom_point() +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq", "R2", "n"))) +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Observed vs Predicted for Since 2022 GAM 10CV Log H2S') +
                        theme_bw()

validation_result_10cv <- rbind(validation_result_10cv, 
                           tibble(Model = 'Since Feb 2022 Log Transform',
                                  'Coef' = summary(lm(obs_10cv_log_trans ~
                                                        pred_10cv_log_trans))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(obs_10cv_log_trans ~
                                                        pred_10cv_log_trans))$r.squared))

# model 2: Transform Pred and Resp
obs_10cv_both_trans <- c()
pred_10cv_both_trans <- c()
adj_r2_both_trans <- c()
adj_r2_test_both_trans <- c()

set.seed(random_seeds[2])
folds <- createFolds(seq(1, nrow(daily_avg_train_sincefeb2022_both_trans)), k = 10)
  
for (fold in seq(1, 10)) {
  test <- daily_avg_train_sincefeb2022_both_trans[folds[[fold]], ]
  train <- anti_join(daily_avg_train_sincefeb2022_both_trans, test, by = join_by(dist_dc, day))
  
  h2s_da_model_10cv <- gam(H2S_daily_avg~s(as.numeric(month),bs='cc') + year + as.character(weekday) +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          dist_wrp + MinDist + 
                         s(mon_utm_x, mon_utm_y, bs='tp', k = 10) + 
                        te(mon_utm_x, mon_utm_y, as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        dist_dc + avg_temp + avg_hum + precip, 
                      data = daily_avg_train_sincefeb2022_both_trans)

  predictions <- predict(h2s_da_model_10cv, newdata = test)
  r2_test <- R2(test$H2S_daily_avg, predictions)
  adj_r2_test <- adj_r2(r2_test, summary(h2s_da_model_10cv)$n, summary(h2s_da_model_10cv)$np)
  
  obs_10cv_both_trans <- append(obs_10cv_both_trans, test %>% pull(H2S_daily_avg))
  pred_10cv_both_trans <- append(pred_10cv_both_trans, predictions)
  adj_r2_both_trans <- append(adj_r2_both_trans, summary(h2s_da_model_10cv)$r.sq)
  adj_r2_test_both_trans <- append(adj_r2_test_both_trans, adj_r2_test)
}

result_10cv <- rbind(result_10cv, tibble(Model = 'Since Feb 2022 Both Transform',
                               '10CV AVG Train R-Sq' = mean(adj_r2_both_trans),
                               '10CV AVG Test R-Sq' = mean(adj_r2_test_both_trans),
                               'Test RMSE' = RMSE(pred_10cv_both_trans, obs_10cv_both_trans)))

both_trans_10cv_obs_vs_pred_plot <- ggplot(tibble(obs = obs_10cv_both_trans, pred = pred_10cv_both_trans),
                             aes(x = pred, y = obs)) +
                        geom_point() +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq", "R2", "n"))) +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Observed vs Predicted for Since 2022 GAM 10CV both transform') +
                        theme_bw()

validation_result_10cv <- rbind(validation_result_10cv, 
                           tibble(Model = 'Since Feb 2022 Both Transform',
                                  'Coef' = summary(lm(obs_10cv_both_trans ~
                                                        pred_10cv_both_trans))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(obs_10cv_both_trans ~
                                                        pred_10cv_both_trans))$r.squared))

# model 3: Transform response according to boxcox
obs_10cv_resp_trans <- c()
pred_10cv_resp_trans <- c()
adj_r2_resp_trans <- c()
adj_r2_test_resp_trans <- c()

set.seed(random_seeds[3])
folds <- createFolds(seq(1, nrow(daily_avg_train_sincefeb2022_trans_resp)), k = 10)
  
for (fold in seq(1, 10)) {
  test <- daily_avg_train_sincefeb2022_trans_resp[folds[[fold]], ]
  train <- anti_join(daily_avg_train_sincefeb2022_trans_resp, test, by = join_by(dist_dc, day))
  
  h2s_da_model_10cv <- gam(H2S_daily_avg~s(as.numeric(month),bs='cc') + year + as.character(weekday) +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                        te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        I(1/dist_dc^2) + avg_temp + avg_hum + precip, 
                      data = daily_avg_train_sincefeb2022_trans_resp)

  predictions <- predict(h2s_da_model_10cv, newdata = test)
  r2_test <- R2(test$H2S_daily_avg, predictions)
  adj_r2_test <- adj_r2(r2_test, summary(h2s_da_model_10cv)$n, summary(h2s_da_model_10cv)$np)
  
  obs_10cv_resp_trans <- append(obs_10cv_resp_trans, test %>% pull(H2S_daily_avg))
  pred_10cv_resp_trans <- append(pred_10cv_resp_trans, predictions)
  adj_r2_resp_trans <- append(adj_r2_resp_trans, summary(h2s_da_model_10cv)$r.sq)
  adj_r2_test_resp_trans <- append(adj_r2_test_resp_trans, adj_r2_test)
}

result_10cv <- rbind(result_10cv, tibble(Model = 'Since Feb 2022 Resp Transform',
                               '10CV AVG Train R-Sq' = mean(adj_r2_resp_trans),
                               '10CV AVG Test R-Sq' = mean(adj_r2_test_resp_trans),
                               'Test RMSE' = RMSE(pred_10cv_resp_trans, obs_10cv_resp_trans)))

resp_trans_10cv_obs_vs_pred_plot <- ggplot(tibble(obs = obs_10cv_resp_trans, pred = pred_10cv_resp_trans),
                             aes(x = pred, y = obs)) +
                        geom_point() +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq", "R2", "n"))) +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Observed vs Predicted for Since 2022 GAM 10CV resp H2S') +
                        theme_bw()

validation_result_10cv <- rbind(validation_result_10cv, 
                           tibble(Model = 'Since Feb 2022 Resp Transform',
                                  'Coef' = summary(lm(obs_10cv_resp_trans ~
                                                        pred_10cv_resp_trans))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(obs_10cv_resp_trans ~
                                                        pred_10cv_resp_trans))$r.squared))

validation_result_10cv
```


# XGBoost: H2S^0.37
```{r}
validation_result <- tibble(Model = character(),
                            'Coef' = character(),
                            'R-Sq' = numeric())

xgb_result <- tibble(Model = character(),
                 '10CV Train R-Sq' = numeric(),
                 '10CV Test R-Sq' = numeric(),
                 '10CV Test RMSE' = numeric())

daily_avg_train_sincefeb2022_trans_resp <- daily_avg_train_sincefeb2022_trans_resp %>%
  mutate(daily_downwind_ref = as.integer(daily_downwind_ref),
         daily_downwind_wrp = as.integer(daily_downwind_wrp))

train <- fastDummies::dummy_cols(daily_avg_train_sincefeb2022_trans_resp %>%
                   select(-c(day)) %>%
                   mutate(MinDist = 1/(MinDist^2),
                          dist_wrp = 1/(dist_wrp^2),
                          weekday = as.character(weekday)),
                   remove_selected_columns = TRUE)

# Try for a continuous month
tune_grid <- expand.grid(nrounds = c(100, 200, 500),
                         max_depth = c(3, 4, 5),
                         eta = c(0.1, 0.3),
                         gamma = c(0.01, 0.001),
                         colsample_bytree = c(0.5, 1),
                         min_child_weight = 0,
                         subsample = c(0.5, 0.75, 1))

# Run algorithms using 10-fold cross validation
control <- trainControl(method="cv", 
                        number=10,
                        verboseIter=TRUE, 
                        search='grid',
                        savePredictions = 'final')

fit.xgb_da_resp_trans <- readRDS('rfiles/fit.xgb_da_resp_trans.rds')
# fit.xgb_da_resp_trans <- train(H2S_daily_avg~.,
#                  method = 'xgbTree',
#                  data = train,
#                  trControl=control,
#                  tuneGrid = tune_grid,
#                  tuneLength = 10, importance=TRUE, verbosity = 0, verbose=FALSE)
# saveRDS(fit.xgb_da_resp_trans, 'rfiles/fit.xgb_da_resp_trans.rds')
```

```{r}
getTrainPerf(fit.xgb_da_resp_trans)
```

```{r}
fit.xgb_da_resp_trans$finalModel
```

```{r}
names <- c("Longitude" = "mon_utm_x", "Latitude" = "mon_utm_y",
        "Distance to Refinery" = "MinDist", "Angle to Refinery" = "Converted_Angle",
        "Active Wells within 1km" = "active_1km", 
        "Monthly Oil Production 1km" = "monthly_oil_1km",
        "Monthly Gas Production 1km" = "monthly_gas_1km",
        "Distance to WRP" = "dist_wrp",
        "WRP Capacity" = "dist_wrp",
        "Angle to WRP" = "wrp_angle",
        "Distance to Dominguez Channel" = "dist_dc",
        "Average Daily Temperature" = "avg_temp",
        "Average Daily Humidity" = "avg_hum",
        "Daily Precipitation" = "precip",
        "Average Daily Wind Speed" = "ws_avg",
        "Average Daily Wind Direction" = "wd_avg",
        "Downwind Refinery" = "daily_downwind_ref",
        "Downwind WRP" = "daily_downwind_wrp",
        "Elevation" = "elevation",
        "Enhanced Vegetation Index" = "EVI",
        "Number of Daily Odor Complaints" = "num_odor_complaints",
        "Year 2022" = "year_2022",
        "Year 2023" = "year_2023",
        "January" = "month_01",
        "February" = "month_02",
        "March" = "month_03",
        "April" = "month_04",
        "May" = "month_05",
        "June" = "month_06", 
        "July" = "month_07",
        "August" = "month_08",
        "September" = "month_09",
        "October" = "month_10",
        "November" = "month_11",
        "December" = "month_12",
        "Monday" = "weekday_Mon",
        "Tuesday" = "weekday_Tue",
        "Wednesday" = "weekday_Wed",
        "Thursday" = "weekday_Thu",
        "Friday" = "weekday_Fri",
        "Saturday" = "weekday_Sat",
        "Sunday" = "weekday_Sun")

imp<-varImp(fit.xgb_da_resp_trans,scale=FALSE)

# rename variables
imp <- tibble(variable = rownames(imp$importance), importance = imp$importance$Overall) %>%
    pivot_wider(names_from = variable, 
                values_from = importance) %>%
    rename(any_of(names)) %>%
    pivot_longer(cols = everything(),names_to = 'variable', values_to = 'importance')

imp %>%
  top_n(15, importance) %>%
  ggplot(aes(x=reorder(variable, importance), y=importance)) + 
  geom_point() +
  geom_segment(aes(x=variable,xend=variable,y=0,yend=importance)) +
  ylab("importance") +
  xlab("Variable") +
  coord_flip() +
  theme_minimal()
```

### Fold Performance
```{r}
# Here, we compute the R2 and RMSE for each fold and take the average
fold_stat <- fit.xgb_da_resp_trans$pred %>% group_by(Resample) %>% 
  summarise(R2 = R2(pred, obs), RMSE = RMSE(pred, obs))
test_r2 <- mean(fold_stat$R2)
test_rmse <- mean(fold_stat$RMSE)
```

```{r}
resp_trans_xgb_sincefeb2022_obs_vs_pred_plot <- ggplot(tibble(obs = fit.xgb_da_resp_trans$pred$obs, 
                                                              pred = fit.xgb_da_resp_trans$pred$pred),
                             aes(x = pred, y = obs)) +
                        geom_point() +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Observed vs Predicted for Since 2022 XGBoost Resp Transform') +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq", "R2", "n"))) +
                        theme_bw()
```

```{r}
validation_result <- rbind(validation_result, 
                           tibble(Model = 'Since Feb 2022 Resp Transform',
                                  'Coef' = summary(lm(fit.xgb_da_resp_trans$pred$obs ~
                                                        fit.xgb_da_resp_trans$pred$pred))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(fit.xgb_da_resp_trans$pred$obs ~
                                                        fit.xgb_da_resp_trans$pred$pred))$r.squared))
```

### SHAP
```{r}
matrix <- train %>% select(-H2S_daily_avg)
matrix <- as.matrix(sapply(matrix, as.numeric))  
xgb.plot.shap(data = matrix, 
              model = fit.xgb_da_resp_trans$finalModel, top_n = 12, n_col = 3)
```

```{r}
xgb.ggplot.shap.summary(data = matrix, 
              model = fit.xgb_da_resp_trans$finalModel, top_n = 20)
```
```{r}
train_adj_r2 <- adj_r2(getTrainPerf(fit.xgb_da_resp_trans)$TrainRsquared, 
                       nrow(fit.xgb_da_resp_trans$trainingData), 
                       fit.xgb_da_resp_trans$finalModel$nfeatures)
test_adj_r2 <- adj_r2(test_r2, 
                       nrow(fit.xgb_da_resp_trans$trainingData), 
                       fit.xgb_da_resp_trans$finalModel$nfeatures)

xgb_result <- rbind(xgb_result, 
                    tibble(Model = 'Since Feb 2022 Resp Transform',
                           '10CV Train R-Sq' = train_adj_r2,
                           '10CV Test R-Sq' = test_adj_r2,
                           '10CV Test RMSE' = test_rmse))
```

# XGBoost: log(H2S+0.1)
```{r}
train <- daily_avg_train_sincefeb2022 %>% 
  mutate(daily_downwind_ref = as.integer(daily_downwind_ref),
         daily_downwind_wrp = as.integer(daily_downwind_wrp)) %>%
  mutate(H2S_daily_avg = log(H2S_daily_avg+0.1))

train <- fastDummies::dummy_cols(train %>%
                   select(-c(day)) %>%
                   mutate(MinDist = 1/(MinDist^2),
                          dist_wrp = 1/(dist_wrp^2),
                          weekday = as.character(weekday)),
                   remove_selected_columns = TRUE)

# Run algorithms using 10-fold cross validation
control <- trainControl(method="cv", 
                        number=10,
                        verboseIter=TRUE, 
                        search='grid',
                        savePredictions = 'final')

fit.xgb_da_log_h2s <- readRDS('rfiles/fit.xgb_da_log_h2s.rds')
# fit.xgb_da_log_h2s <- train(H2S_daily_avg~.,
#                  method = 'xgbTree',
#                  data = train,
#                  trControl=control,
#                  tuneGrid = tune_grid,
#                  tuneLength = 10, importance=TRUE, verbosity = 0, verbose=FALSE)
# saveRDS(fit.xgb_da_log_h2s, 'rfiles/fit.xgb_da_log_h2s.rds')
```

```{r}
getTrainPerf(fit.xgb_da_log_h2s)
```

```{r}
fit.xgb_da_log_h2s$finalModel
```

```{r}
imp<-varImp(fit.xgb_da_log_h2s,scale=FALSE)

# rename variables
imp <- tibble(variable = rownames(imp$importance), importance = imp$importance$Overall) %>%
    pivot_wider(names_from = variable, 
                values_from = importance) %>%
    rename(any_of(names)) %>%
    pivot_longer(cols = everything(),names_to = 'variable', values_to = 'importance')

imp %>%
  top_n(15, importance) %>%
  ggplot(aes(x=reorder(variable, importance), y=importance)) + 
  geom_point() +
  geom_segment(aes(x=variable,xend=variable,y=0,yend=importance)) +
  ylab("importance") +
  xlab("Variable") +
  coord_flip() +
  theme_minimal()
```

### Fold Performance
```{r}
# Here, we compute the R2 and RMSE for each fold and take the average
fold_stat <- fit.xgb_da_log_h2s$pred %>% group_by(Resample) %>% 
  summarise(R2 = R2(pred, obs), RMSE = RMSE(pred, obs))
test_r2 <- mean(fold_stat$R2)
test_rmse <- mean(fold_stat$RMSE)
```

```{r}
log_h2s_xgb_sincefeb2022_obs_vs_pred_plot <- ggplot(tibble(obs = fit.xgb_da_log_h2s$pred$obs, 
                                                              pred = fit.xgb_da_log_h2s$pred$pred),
                             aes(x = pred, y = obs)) +
                        geom_point() +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Observed vs Predicted for Since 2022 XGBoost Log H2S') +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq", "R2", "n"))) +
                        theme_bw()
```

```{r}
validation_result <- rbind(validation_result, 
                           tibble(Model = 'Since Feb 2022 Log Transform',
                                  'Coef' = summary(lm(fit.xgb_da_log_h2s$pred$obs ~
                                                        fit.xgb_da_log_h2s$pred$pred))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(fit.xgb_da_log_h2s$pred$obs ~
                                                        fit.xgb_da_log_h2s$pred$pred))$r.squared))
```

### SHAP
```{r}
matrix <- train %>% select(-H2S_daily_avg)
matrix <- as.matrix(sapply(matrix, as.numeric))  
xgb.plot.shap(data = matrix, 
              model = fit.xgb_da_log_h2s$finalModel, top_n = 12, n_col = 3)
```


```{r}
xgb.ggplot.shap.summary(data = matrix, 
              model = fit.xgb_da_log_h2s$finalModel, top_n = 20)
```

```{r}
train_adj_r2 <- adj_r2(getTrainPerf(fit.xgb_da_log_h2s)$TrainRsquared, 
                       nrow(fit.xgb_da_log_h2s$trainingData), 
                       fit.xgb_da_log_h2s$finalModel$nfeatures)
test_adj_r2 <- adj_r2(test_r2, 
                       nrow(fit.xgb_da_log_h2s$trainingData), 
                       fit.xgb_da_log_h2s$finalModel$nfeatures)

xgb_result <- rbind(xgb_result, 
                    tibble(Model = 'Since Feb 2022 Log Transform',
                           '10CV Train R-Sq' = train_adj_r2,
                           '10CV Test R-Sq' = test_adj_r2,
                           '10CV Test RMSE' = test_rmse))
```

# XGBoost: Both Transform
```{r}
train <- fastDummies::dummy_cols(daily_avg_train_sincefeb2022_both_trans %>%
                   select(-c(day)) %>%
                   mutate(MinDist = 1/(MinDist^2),
                          dist_wrp = 1/(dist_wrp^2),
                          weekday = as.character(weekday)),
                   remove_selected_columns = TRUE)

# Run algorithms using 10-fold cross validation
control <- trainControl(method="cv", 
                        number=10,
                        verboseIter=TRUE, 
                        search='grid',
                        savePredictions = 'final')

fit.xgb_da_both_trans <- readRDS('rfiles/fit.xgb_da_both_trans.rds')
# fit.xgb_da_both_trans <- train(H2S_daily_avg~.,
#                  method = 'xgbTree',
#                  data = train,
#                  trControl=control,
#                  tuneGrid = tune_grid,
#                  tuneLength = 10, importance=TRUE, verbosity = 0, verbose=FALSE)
# saveRDS(fit.xgb_da_both_trans, 'rfiles/fit.xgb_da_both_trans.rds')
```

```{r}
getTrainPerf(fit.xgb_da_both_trans)
```

```{r}
fit.xgb_da_both_trans$finalModel
```

```{r}
imp<-varImp(fit.xgb_da_both_trans,scale=FALSE)

# rename variables
imp <- tibble(variable = rownames(imp$importance), importance = imp$importance$Overall) %>%
    pivot_wider(names_from = variable, 
                values_from = importance) %>%
    rename(any_of(names)) %>%
    pivot_longer(cols = everything(),names_to = 'variable', values_to = 'importance')

imp %>%
  top_n(15, importance) %>%
  ggplot(aes(x=reorder(variable, importance), y=importance)) + 
  geom_point() +
  geom_segment(aes(x=variable,xend=variable,y=0,yend=importance)) +
  ylab("importance") +
  xlab("Variable") +
  coord_flip() +
  theme_minimal()
```

### Fold Performance
```{r}
# Here, we compute the R2 and RMSE for each fold and take the average
fold_stat <- fit.xgb_da_both_trans$pred %>% group_by(Resample) %>% 
  summarise(R2 = R2(pred, obs), RMSE = RMSE(pred, obs))
test_r2 <- mean(fold_stat$R2)
test_rmse <- mean(fold_stat$RMSE)
```

```{r}
both_trans_xgb_sincefeb2022_obs_vs_pred_plot <- ggplot(tibble(obs = fit.xgb_da_both_trans$pred$obs, 
                                                              pred = fit.xgb_da_both_trans$pred$pred),
                             aes(x = pred, y = obs)) +
                        geom_point() +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Observed vs Predicted for Since 2022 XGBoost Resp Transform') +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq", "R2", "n"))) +
                        theme_bw()
```

```{r}
validation_result <- rbind(validation_result, 
                           tibble(Model = 'Since Feb 2022 Both Transform',
                                  'Coef' = summary(lm(fit.xgb_da_both_trans$pred$obs ~
                                                        fit.xgb_da_both_trans$pred$pred))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(fit.xgb_da_both_trans$pred$obs ~
                                                        fit.xgb_da_both_trans$pred$pred))$r.squared))
```

### SHAP
```{r}
matrix <- train %>% select(-H2S_daily_avg)
matrix <- as.matrix(sapply(matrix, as.numeric))  
xgb.plot.shap(data = matrix, 
              model = fit.xgb_da_both_trans$finalModel, top_n = 12, n_col = 3)
```


```{r}
xgb.ggplot.shap.summary(data = matrix, 
              model = fit.xgb_da_both_trans$finalModel, top_n = 20)
```

```{r}
train_adj_r2 <- adj_r2(getTrainPerf(fit.xgb_da_both_trans)$TrainRsquared, 
                       nrow(fit.xgb_da_both_trans$trainingData), 
                       fit.xgb_da_both_trans$finalModel$nfeatures)
test_adj_r2 <- adj_r2(test_r2, 
                       nrow(fit.xgb_da_both_trans$trainingData), 
                       fit.xgb_da_both_trans$finalModel$nfeatures)

xgb_result <- rbind(xgb_result, 
                    tibble(Model = 'Since Feb 2022 Both Transform',
                           '10CV Train R-Sq' = train_adj_r2,
                           '10CV Test R-Sq' = test_adj_r2,
                           '10CV Test RMSE' = test_rmse))
```

# Result Comparison
# Comparison
```{r}
knitr::kable(tibble(Model = c('Since Feb 2022',
                              'Since Feb 2022 Log Transform',
                              'Since Feb 2022 Both Transform',
                              'Since Feb 2022 Resp Transform'),
                    'Train R-sq' = c(0.67,
                                    round(summary(h2s_da_model_f_logresp)$r.sq, 2),
                                    round(summary(h2s_da_model_f_trans)$r.sq, 2),
                                    round(summary(h2s_da_model_f_trans_resp)$r.sq, 2))) %>% 
               left_join(rbind(result_10cv, tibble(Model = 'Since Feb 2022', 
                                                   '10CV AVG Train R-Sq' = 0.664,
                                                   '10CV AVG Test R-Sq' = 0.665,
                                                   'Test RMSE' = 0.357)), join_by(Model)) %>%
               left_join(rbind(xgb_result, tibble(Model = 'Since Feb 2022', 
                                                   '10CV Train R-Sq' = 0.777,
                                                   '10CV Test R-Sq' = 0.777,
                                                   '10CV Test RMSE' = 0.283)), join_by(Model)),
             digits = 3)
```

```{r}
ggarrange(log_h2s_10cv_obs_vs_pred_plot, 
          both_trans_10cv_obs_vs_pred_plot,
          resp_trans_10cv_obs_vs_pred_plot, 
          labels = c("1", "2", "3"),
          nrow = 3)
```

```{r}
ggarrange(log_h2s_xgb_sincefeb2022_obs_vs_pred_plot, 
          resp_trans_xgb_sincefeb2022_obs_vs_pred_plot,
          both_trans_xgb_sincefeb2022_obs_vs_pred_plot, 
          labels = c("1", "2", "3"),
          nrow = 3)
```
