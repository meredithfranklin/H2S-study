---
title: "Box Cox Data Modelling"
author: "Jerry Wu"
date: "9/19/2023"
output:
  html_document:
    df_print: paged
  pdf_document: default
abstract: ''
subtitle: ''
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
library(tidyverse)
library(mgcv)
library(mgcViz)
library(caret)
library(car)
library(xgboost)
library(ggpmisc)
library(GGally)
library(ggpubr)
select <- dplyr::select
```

```{r}
full_data <- readRDS('data/full_data.rds')
daily_full <- readRDS('data/daily_full.rds')
```

# Data setup
```{r}
predictors <- c('H2S_daily_avg', 'month', 'year', 'weekday', 'wd_avg', 'ws_avg', 
                'daily_downwind_ref', 'dist_wrp', 'MinDist',
                'mon_utm_x', 'mon_utm_y', 'day', 'monthly_oil_1km', 'monthly_gas_1km', 
                'active_1km', 'daily_downwind_wrp', 'elevation', 'EVI', 'num_odor_complaints',
                'dist_dc', 'capacity', 'avg_temp', 'avg_hum', 'precip') 

# get train data set for daily average H2S
daily_avg_train_sincefeb2022 <- daily_full[complete.cases(daily_full),] %>% 
  filter(day >= '2022-02-01') %>%
  select(all_of(predictors))
```

# Explore H2S concentration
```{r}
ggplot(daily_avg_train_sincefeb2022, aes(x = H2S_daily_avg)) +
  geom_histogram(fill = "salmon", col = "white")

ggplot(daily_avg_train_sincefeb2022, aes(x = H2S_daily_avg)) +
  geom_histogram(fill = "salmon", col = "white") + 
  scale_x_continuous(limits = c(0, 2.5))
```

# GAM
## Since Feb 2022
```{r}
# Since feb 2022
h2s_da_model_f <- gam(H2S_daily_avg~s(as.numeric(month),bs='cc') + year + weekday +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                        te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        I(1/dist_dc^2) + avg_temp + avg_hum + precip, 
                      data = daily_avg_train_sincefeb2022)
summary(h2s_da_model_f)
plot(h2s_da_model_f)
```

### Condition 1
```{r}
# Check Condition 1
ggplot(tibble(obs = daily_avg_train_sincefeb2022$H2S_daily_avg, pred = fitted(h2s_da_model_f)),
                             aes(x = pred, y = obs)) +
                        geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +                                                         geom_point() +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq")), label.x = "right", label.y = 0.15) +                                                stat_poly_eq(use_label(c("R2")), label.x = "right", label.y = 0.1) +                                                 stat_poly_eq(use_label(c("n")), label.x = "right", label.y = 0.05) +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Observed vs Predicted for Since 2022 GAM') +
                        theme_bw()
```

### Condition 2
```{r}
# Check condition 2
# pair <- ggpairs(daily_avg_train_sincefeb2022, lower=list(continuous=ggally_points, combo=ggally_box_no_facet), upper=list(continuous = "blankDiag", discrete = "blankDiag", combo = "blankDiag"), diag=list(continuous = "blankDiag", discrete = "blankDiag", combo = "blankDiag"), axisLabels="show", cardinality_threshold = 55, progress = FALSE)
# pair
```

### Residual Plots
```{r}
# Residual plots
rs_full <- h2s_da_model_f$residuals
plot(rs_full~fitted(h2s_da_model_f), xlab="Fitted", ylab="Residuals")
```

```{r}
par(mfrow=c(2,3))
for(i in c(2:3, 5:length(daily_avg_train_sincefeb2022))){
  print(i)
  plot(rs_full~unlist(daily_avg_train_sincefeb2022[,i]), xlab=names(daily_avg_train_sincefeb2022)[i], ylab="Residuals")
}
```

```{r}
# Normal Q-Q Plot
stats::qqnorm(rs_full, sub = "Since Feb 2022 before transformation")
stats::qqline(rs_full)
```

```{r}
stats::qqnorm(rs_full, sub = "Since Feb 2022 before transformation w.o zoomed in",
              ylim = c(-1, 2))
stats::qqline(rs_full)
```

# Box Cox Transformations
## Identifying lambda
### Since Feb 2022
```{r}
# try transformations
# On both response and predictors
# transform_all <- readRDS('rfiles/transform_all.rds')
#transform_all <- powerTransform(as.matrix(daily_avg_train_sincefeb2022 %>%
#                                            select(-c(month, day, year, weekday))), 
#                                family = "bcnPower")
#saveRDS(transform_all, 'rfiles/transform_all.rds')
# summary(transform_all)

# On only predictors
# transform_pred <- readRDS('rfiles/transform_pred.rds')
# transform_pred <- powerTransform(as.matrix(daily_avg_train_sincefeb2022 %>%
#                                              select(-c(month, day, year, weekday,
#                                                        H2S_daily_avg))),
#                                 family = "bcnPower")
# saveRDS(transform_pred, 'rfiles/transform_pred.rds')
# summary(transform_pred)

# On only response, using bcPower since this cannot be negative
transform_resp_sincefeb2022 <- 
  powerTransform(as.matrix(daily_avg_train_sincefeb2022 %>%
                             select(H2S_daily_avg)),
                                 family = "bcPower")
summary(transform_resp_sincefeb2022)

# This suggests a log transformation
```

### Disaster Only
```{r}
transform_resp_dis_only <- 
  powerTransform(as.matrix(daily_full %>%
                             filter(year == '2021', month %in% c('10', '11', '12')) %>%
                             select(H2S_daily_avg)),
                                 family = "bcPower")
summary(transform_resp_dis_only)
# This is actually slightly below 0
```

### Excluding Disaster
```{r}
transform_resp_excl_dis <- 
  powerTransform(as.matrix(daily_full %>%
                             filter(!(year == '2021' & month %in% c('10', '11', '12'))) %>%
                             select(H2S_daily_avg)),
                                 family = "bcPower")
summary(transform_resp_excl_dis)

# This is very close to 0, suggesting a log transformation
```

### Everything Since 2020
```{r}
transform_resp_everything <- 
  powerTransform(as.matrix(daily_full %>%
                             select(H2S_daily_avg)),
                                 family = "bcPower")
summary(transform_resp_everything)

# This is slightly closer to 0 than the disaster only period
```


## Tranforming the models
### Since Feb 2022
```{r}
ggplot(daily_avg_train_sincefeb2022, aes(x = log(H2S_daily_avg))) +
  geom_histogram(fill = "salmon", col = "white")
```

```{r}
logh2s_da_sincefeb2022 <- gam(I(log(H2S_daily_avg))~s(as.numeric(month),bs='cc') + year + weekday +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                        te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        I(1/dist_dc^2) + avg_temp + avg_hum + precip, 
                      data = daily_avg_train_sincefeb2022)
summary(logh2s_da_sincefeb2022)
plot(logh2s_da_sincefeb2022)
```
#### Model table
```{r}
get_gam_result <- function(model_obj, model_name){
  p <- summary(model_obj)$p.pv
  coef <- tibble(Term = names(summary(model_obj)$p.coeff), x = summary(model_obj)$p.coeff) %>%
              mutate(x = paste0(formatC(x, format = 'e', digits = 2), 
                              case_when(p < 0.001 ~ '***', 
                                        0.001 <= p & p < 0.01 ~ '**', 
                                        0.01 <= p & p < 0.05 ~ '*', 
                                        0.05 <= p & p < 0.1 ~ '.', 
                                        TRUE ~ '')))  %>%
              rename({{model_name}} := x)
  coef <- rbind(coef, tibble(Term = 'Adj.R-sq', {{model_name}} := 
                             formatC(summary(model_obj)$r.sq, format = 'e', 
                             digits = 2)))
  return(coef)
}
sincefeb2022_model_stat <- get_gam_result(logh2s_da_sincefeb2022, 'Daily Average H2S Since Feb 2022') 

sincefeb2022_model_stat_latex <- knitr::kable(sincefeb2022_model_stat, format = 'latex', digits = 2)
writeLines(sincefeb2022_model_stat_latex, 'figures/sincefeb2022_log_model.tex')

knitr::kable(sincefeb2022_model_stat, format = 'html', digits = 2)
```

#### Condition 1
```{r}
# Check Condition 1
ggplot(tibble(obs = log(daily_avg_train_sincefeb2022$H2S_daily_avg), pred = fitted(logh2s_da_sincefeb2022)),
                             aes(x = pred, y = obs)) +
                        geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +                                                         geom_point() +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq")), label.x = "right", label.y = 0.15) +                                                stat_poly_eq(use_label(c("R2")), label.x = "right", label.y = 0.1) +                                                 stat_poly_eq(use_label(c("n")), label.x = "right", label.y = 0.05) +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Obs vs Pred with log(H2S) transformation',
                             subtitle = 'Since Feb 2022') +
                        theme_bw()
```

#### Residual Plots
```{r}
# Residual plots
rs_full <- logh2s_da_sincefeb2022$residuals
plot(rs_full~fitted(logh2s_da_sincefeb2022), xlab="Fitted", ylab="Residuals")
```


```{r}
# Normal Q-Q Plot
stats::qqnorm(rs_full, sub = "Since Feb 2022 after log transformation")
stats::qqline(rs_full)
```
### Disaster Only
```{r}
disaster <- daily_full %>% 
  filter(year == '2021', month %in% c('10', '11', '12')) %>% 
  select(all_of(predictors)) %>% 
  filter(complete.cases(.))
```

```{r}
ggplot(disaster, 
       aes(x = log(H2S_daily_avg))) +
  geom_histogram(fill = "salmon", col = "white")
```

```{r}
logh2s_da_dis <- gam(I(log(H2S_daily_avg))~month + weekday +
                         wd_avg + ws_avg + daily_downwind_ref + I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                         te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                            k = c(10,10), d = c(2,1), bs = c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                         daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                         capacity + dist_dc + avg_temp + avg_hum + precip, 
                      data = disaster)
summary(logh2s_da_dis)
plot(logh2s_da_dis)
```

### Exclude Disaster
```{r}
excl_disaster <- daily_full %>% 
  filter(!(year == '2021' & month %in% c('10', '11', '12'))) %>% 
  select(all_of(predictors)) %>% 
  filter(complete.cases(.))
```

```{r}
ggplot(excl_disaster, 
       aes(x = log(H2S_daily_avg))) +
  geom_histogram(fill = "salmon", col = "white")
```

```{r}
logh2s_da_excl_dis <- gam(I(log(H2S_daily_avg))~s(as.numeric(month),bs='cc') + year + weekday +
                         wd_avg + ws_avg + daily_downwind_ref + I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                         te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                            k = c(10,10), d = c(2,1), bs = c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                         daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                         capacity + dist_dc + avg_temp + avg_hum + precip, 
                      data = excl_disaster)
summary(logh2s_da_excl_dis)
plot(logh2s_da_excl_dis)
```

### Everything w. Disaster Indicator
```{r}
everything <- daily_full %>% 
  select(all_of(predictors)) %>% 
  mutate(disaster = if_else(year == '2021' & month %in% c('10', '11', '12'), 1, 0)) %>% 
  filter(complete.cases(.)) 
```

```{r}
ggplot(everything, aes(x = log(H2S_daily_avg))) +
  geom_histogram(fill = "salmon", col = "white")
```

```{r}
logh2s_da_full_dis_ind <- gam(I(log(H2S_daily_avg))~s(as.numeric(month),bs='cc') + year + weekday +
                         wd_avg + ws_avg + daily_downwind_ref + I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                         te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                            k = c(10,10), d = c(2,1), bs = c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                         daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                         capacity + dist_dc + avg_temp + avg_hum + precip + disaster, 
                      data = everything)
summary(logh2s_da_full_dis_ind)
plot(logh2s_da_full_dis_ind)
```

### Everything w.o Disaster Indicator
```{r}
logh2s_da_full <- gam(I(log(H2S_daily_avg))~s(as.numeric(month),bs='cc') + year + weekday +
                         wd_avg + ws_avg + daily_downwind_ref + I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                         te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                            k = c(10,10), d = c(2,1), bs = c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                         daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                         capacity + dist_dc + avg_temp + avg_hum + precip, 
                      data = everything)
summary(logh2s_da_full)
plot(logh2s_da_full)
```

# 10-fold CV
```{r}
adj_r2 <- function(r2, n, p){
  return(1 - (1-r2)*(n - 1)/(n - p - 1))
}
```

```{r}
set.seed(1)
random_seeds <- floor(runif(5, min=0, max=1)*100)
```

```{r}
result_10cv <- tibble(Model = character(),
                 '10CV AVG Train R-Sq' = numeric(),
                 '10CV AVG Test R-Sq' = numeric(),
                 'Test RMSE' = numeric(),
                 'B-T Test RMSE' = numeric())

validation_result_10cv <- tibble(Model = character(),
                            'Coef' = numeric(),
                            'R-Sq' = numeric())

# model 1: Since Feb 2022
obs_10cv_sincefeb2022 <- c()
pred_10cv_sincefeb2022 <- c()
adj_r2_sincefeb2022 <- c()
adj_r2_test_sincefeb2022 <- c()
rmse_sincefeb2022 <- c()
btrmse_sincefeb2022 <- c()

set.seed(random_seeds[1])
folds <- createFolds(seq(1, nrow(daily_avg_train_sincefeb2022)), k = 10)
  
for (fold in seq(1, 10)) {
  test <- daily_avg_train_sincefeb2022[folds[[fold]], ]
  train <- anti_join(daily_avg_train_sincefeb2022, test, by = join_by(dist_dc, day))
  
  h2s_da_model_10cv <- gam(I(log(H2S_daily_avg))~s(as.numeric(month),bs='cc') + year + weekday +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                        te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        I(1/dist_dc^2) + avg_temp + avg_hum + precip, 
                          data = train)

  predictions <- predict(h2s_da_model_10cv, newdata = test)
  r2_test <- R2(test$H2S_daily_avg, exp(predictions))
  adj_r2_test <- adj_r2(r2_test, summary(h2s_da_model_10cv)$n, summary(h2s_da_model_10cv)$np)
  
  obs_10cv_sincefeb2022 <- append(obs_10cv_sincefeb2022, test %>% pull(H2S_daily_avg))
  pred_10cv_sincefeb2022 <- append(pred_10cv_sincefeb2022, predictions)
  adj_r2_sincefeb2022 <- append(adj_r2_sincefeb2022, summary(h2s_da_model_10cv)$r.sq)
  adj_r2_test_sincefeb2022 <- append(adj_r2_test_sincefeb2022, adj_r2_test)
  rmse_sincefeb2022 <- append(rmse_sincefeb2022, RMSE(predictions, test$H2S_daily_avg))
  btrmse_sincefeb2022 <- append(btrmse_sincefeb2022, RMSE(exp(predictions), test$H2S_daily_avg))
}

result_10cv <- rbind(result_10cv, tibble(Model = 'Since Feb 2022 Log Transform',
                               '10CV AVG Train R-Sq' = mean(adj_r2_sincefeb2022),
                               '10CV AVG Test R-Sq' = mean(adj_r2_test_sincefeb2022),
                               'Test RMSE' = mean(rmse_sincefeb2022),
                               'B-T Test RMSE' = mean(btrmse_sincefeb2022)))

logh2s_10cv_ovp_plot_sincefeb2022 <- ggplot(tibble(obs = obs_10cv_sincefeb2022, pred = exp(pred_10cv_sincefeb2022)),
                             aes(x = pred, y = obs)) +
                        geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +
                        geom_point() +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq")), label.x = "right", label.y = 0.05) +
                        stat_poly_eq(use_label(c("R2")), label.x = "right", label.y = 0.1) +
                        stat_poly_eq(use_label(c("n")), label.x = "right", label.y = 0.15) +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Observed vs Predicted for Since 2022 GAM 10CV Log H2S') +
                        theme_bw()

validation_result_10cv <- rbind(validation_result_10cv, 
                           tibble(Model = 'Since Feb 2022 Log Transform',
                                  'Coef' = summary(lm(obs_10cv_sincefeb2022 ~
                                                        pred_10cv_sincefeb2022))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(obs_10cv_sincefeb2022 ~
                                                        pred_10cv_sincefeb2022))$r.squared))

# model 2: Disaster Only
obs_10cv_disaster <- c()
pred_10cv_disaster <- c()
adj_r2_disaster <- c()
adj_r2_test_disaster <- c()
rmse_disaster <- c()
btrmse_disaster <- c()

set.seed(random_seeds[2])
folds <- createFolds(seq(1, nrow(disaster)), k = 10)
  
for (fold in seq(1, 10)) {
  test <- disaster[folds[[fold]], ]
  train <- anti_join(disaster, test, by = join_by(dist_dc, day))
  
  h2s_da_model_10cv <- gam(I(log(H2S_daily_avg)) ~ month + weekday +
                         wd_avg + ws_avg + daily_downwind_ref + I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                         te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                            k = c(10,10), d = c(2,1), bs = c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                         daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                         capacity + dist_dc + avg_temp + avg_hum + precip, 
                          data = train)

  predictions <- predict(h2s_da_model_10cv, newdata = test)
  r2_test <- R2(test$H2S_daily_avg, exp(predictions))
  adj_r2_test <- adj_r2(r2_test, summary(h2s_da_model_10cv)$n, summary(h2s_da_model_10cv)$np)
  
  obs_10cv_disaster <- append(obs_10cv_disaster, test %>% pull(H2S_daily_avg))
  pred_10cv_disaster <- append(pred_10cv_disaster, predictions)
  adj_r2_disaster <- append(adj_r2_disaster, summary(h2s_da_model_10cv)$r.sq)
  adj_r2_test_disaster <- append(adj_r2_test_disaster, adj_r2_test)
  rmse_disaster <- append(rmse_disaster, RMSE(predictions, test$H2S_daily_avg))
  btrmse_disaster <- append(btrmse_disaster, RMSE(exp(predictions), test$H2S_daily_avg))
}

result_10cv <- rbind(result_10cv, tibble(Model = 'Disaster Only Log Transform',
                               '10CV AVG Train R-Sq' = mean(adj_r2_disaster),
                               '10CV AVG Test R-Sq' = mean(adj_r2_test_disaster),
                               'Test RMSE' = mean(rmse_disaster),
                               'B-T Test RMSE' = mean(btrmse_disaster)))

logh2s_10cv_ovp_plot_dis_only <- ggplot(tibble(obs = obs_10cv_disaster, pred = exp(pred_10cv_disaster)),
                             aes(x = pred, y = obs)) +
                        geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +                                                         geom_point() +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq")), label.x = "right", label.y = 0.15) +                                                stat_poly_eq(use_label(c("R2")), label.x = "right", label.y = 0.1) +                                                 stat_poly_eq(use_label(c("n")), label.x = "right", label.y = 0.05) +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Observed vs Predicted for Disaster GAM 10CV Log H2S') +
                        theme_bw()

validation_result_10cv <- rbind(validation_result_10cv, 
                           tibble(Model = 'Disaster Only Log Transform',
                                  'Coef' = summary(lm(obs_10cv_disaster ~
                                                        pred_10cv_disaster))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(obs_10cv_disaster ~
                                                        pred_10cv_disaster))$r.squared))

# model 3: Exclude Disaster
obs_10cv_excl_dis <- c()
pred_10cv_excl_dis <- c()
adj_r2_excl_dis <- c()
adj_r2_test_excl_dis <- c()
rmse_excl_dis <- c()
btrmse_excl_dis <- c()

set.seed(random_seeds[3])
folds <- createFolds(seq(1, nrow(excl_disaster)), k = 10)
  
for (fold in seq(1, 10)) {
  test <- excl_disaster[folds[[fold]], ]
  train <- anti_join(excl_disaster, test, by = join_by(dist_dc, day))
  
  h2s_da_model_10cv <- gam(I(log(H2S_daily_avg))~s(as.numeric(month),bs='cc') + year + weekday +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                        te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        I(1/dist_dc^2) + avg_temp + avg_hum + precip, 
                          data = train)

  predictions <- predict(h2s_da_model_10cv, newdata = test)
  r2_test <- R2(test$H2S_daily_avg, exp(predictions))
  adj_r2_test <- adj_r2(r2_test, summary(h2s_da_model_10cv)$n, summary(h2s_da_model_10cv)$np)
  
  obs_10cv_excl_dis <- append(obs_10cv_excl_dis, test %>% pull(H2S_daily_avg))
  pred_10cv_excl_dis <- append(pred_10cv_excl_dis, predictions)
  adj_r2_excl_dis <- append(adj_r2_excl_dis, summary(h2s_da_model_10cv)$r.sq)
  adj_r2_test_excl_dis <- append(adj_r2_test_excl_dis, adj_r2_test)
  rmse_excl_dis <- append(rmse_excl_dis, RMSE(predictions, test$H2S_daily_avg))
  btrmse_excl_dis <- append(btrmse_excl_dis, RMSE(exp(predictions), test$H2S_daily_avg))
}

result_10cv <- rbind(result_10cv, tibble(Model = 'Exclude Disaster Log Transform',
                               '10CV AVG Train R-Sq' = mean(adj_r2_excl_dis),
                               '10CV AVG Test R-Sq' = mean(adj_r2_test_excl_dis),
                               'Test RMSE' = mean(rmse_excl_dis),
                               'B-T Test RMSE' = mean(btrmse_excl_dis)))

logh2s_10cv_ovp_plot_excl_dis <- ggplot(tibble(obs = obs_10cv_excl_dis, pred = exp(pred_10cv_excl_dis)),
                             aes(x = pred, y = obs)) +
                        geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +                                                         geom_point() +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq")), label.x = "right", label.y = 0.15) +                         stat_poly_eq(use_label(c("R2")), label.x = "right", label.y = 0.1) +                         stat_poly_eq(use_label(c("n")), label.x = "right", label.y = 0.05) +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Observed vs Predicted for Excl Dis GAM 10CV Log H2S') +
                        theme_bw()

validation_result_10cv <- rbind(validation_result_10cv, 
                           tibble(Model = 'Exclude Disaster Log Transform',
                                  'Coef' = summary(lm(obs_10cv_excl_dis ~
                                                        pred_10cv_excl_dis))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(obs_10cv_excl_dis ~
                                                        pred_10cv_excl_dis))$r.squared))

# model 4: Everything w. Disaster Indicator
obs_10cv_disaster_ind <- c()
pred_10cv_disaster_ind <- c()
adj_r2_disaster_ind <- c()
adj_r2_test_disaster_ind <- c()
rmse_disaster_ind <- c()
btrmse_disaster_ind <- c()

set.seed(random_seeds[4])
folds <- createFolds(seq(1, nrow(everything)), k = 10)
  
for (fold in seq(1, 10)) {
  test <- everything[folds[[fold]], ]
  train <- anti_join(everything, test, by = join_by(dist_dc, day))
  
  h2s_da_model_10cv <- gam(I(log(H2S_daily_avg))~s(as.numeric(month),bs='cc') + year + weekday +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                        te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        I(1/dist_dc^2) + avg_temp + avg_hum + precip + disaster, 
                          data = train)

  predictions <- predict(h2s_da_model_10cv, newdata = test)
  r2_test <- R2(test$H2S_daily_avg, exp(predictions))
  adj_r2_test <- adj_r2(r2_test, summary(h2s_da_model_10cv)$n, summary(h2s_da_model_10cv)$np)
  
  obs_10cv_disaster_ind <- append(obs_10cv_disaster_ind, test %>% pull(H2S_daily_avg))
  pred_10cv_disaster_ind <- append(pred_10cv_disaster_ind, predictions)
  adj_r2_disaster_ind <- append(adj_r2_disaster_ind, summary(h2s_da_model_10cv)$r.sq)
  adj_r2_test_disaster_ind <- append(adj_r2_test_disaster_ind, adj_r2_test)
  rmse_disaster_ind <- append(rmse_disaster_ind, RMSE(predictions, test$H2S_daily_avg))
  btrmse_disaster_ind <- append(btrmse_disaster_ind, RMSE(exp(predictions), test$H2S_daily_avg))
}

result_10cv <- rbind(result_10cv, tibble(Model = 'Everything w. Disaster Indicator Log Transform',
                               '10CV AVG Train R-Sq' = mean(adj_r2_disaster_ind),
                               '10CV AVG Test R-Sq' = mean(adj_r2_test_disaster_ind),
                               'Test RMSE' = mean(rmse_disaster_ind),
                               'B-T Test RMSE' = mean(btrmse_disaster_ind)))

logh2s_10cv_ovp_plot_dis_ind <- ggplot(tibble(obs = obs_10cv_disaster_ind, pred = exp(pred_10cv_disaster_ind)),
                             aes(x = pred, y = obs)) +
                        geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +                                                         geom_point() +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq")), label.x = "right", label.y = 0.15) +                         stat_poly_eq(use_label(c("R2")), label.x = "right", label.y = 0.1) +                         stat_poly_eq(use_label(c("n")), label.x = "right", label.y = 0.05) +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Everything w. Disaster Indicator') +
                        theme_bw()

validation_result_10cv <- rbind(validation_result_10cv, 
                           tibble(Model = 'Everything w. Disaster Indicator Log Transform',
                                  'Coef' = summary(lm(obs_10cv_disaster_ind ~
                                                        pred_10cv_disaster_ind))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(obs_10cv_disaster_ind ~
                                                        pred_10cv_disaster_ind))$r.squared))

# model 5: Everything w.o Disaster Indicator
obs_10cv_everything <- c()
pred_10cv_everything <- c()
adj_r2_everything <- c()
adj_r2_test_everything <- c()
rmse_everything <- c()
btrmse_everything <- c()

set.seed(random_seeds[5])
folds <- createFolds(seq(1, nrow(everything)), k = 10)
  
for (fold in seq(1, 10)) {
  test <- everything[folds[[fold]], ]
  train <- anti_join(everything, test, by = join_by(dist_dc, day))
  
  h2s_da_model_10cv <- gam(I(log(H2S_daily_avg))~s(as.numeric(month),bs='cc') + year + weekday +
                         wd_avg + ws_avg + daily_downwind_ref + capacity +
                          I(1/dist_wrp^2) + I(1/MinDist^2) +
                         s(I(mon_utm_x/10^3), I(mon_utm_y/10^3), bs='tp', k = 10) + 
                        te(I(mon_utm_x/10^3), I(mon_utm_y/10^3), as.numeric(day),
                           k=c(10,10),d=c(2,1),bs=c('tp','cc')) +
                         monthly_oil_1km + monthly_gas_1km + active_1km + 
                        daily_downwind_wrp + elevation + EVI + num_odor_complaints +
                        I(1/dist_dc^2) + avg_temp + avg_hum + precip, 
                          data = train)

  predictions <- predict(h2s_da_model_10cv, newdata = test)
  r2_test <- R2(test$H2S_daily_avg, exp(predictions))
  adj_r2_test <- adj_r2(r2_test, summary(h2s_da_model_10cv)$n, summary(h2s_da_model_10cv)$np)
  
  obs_10cv_everything <- append(obs_10cv_everything, test %>% pull(H2S_daily_avg))
  pred_10cv_everything <- append(pred_10cv_everything, predictions)
  adj_r2_everything <- append(adj_r2_everything, summary(h2s_da_model_10cv)$r.sq)
  adj_r2_test_everything <- append(adj_r2_test_everything, adj_r2_test)
  rmse_everything <- append(rmse_everything, RMSE(predictions, test$H2S_daily_avg))
  btrmse_everything <- append(btrmse_everything, RMSE(exp(predictions), test$H2S_daily_avg))
}

result_10cv <- rbind(result_10cv, tibble(Model = 'Everything w.o Disaster Indicator Log Transform',
                               '10CV AVG Train R-Sq' = mean(adj_r2_everything),
                               '10CV AVG Test R-Sq' = mean(adj_r2_test_everything),
                               'Test RMSE' = mean(rmse_everything),
                               'B-T Test RMSE' = mean(btrmse_everything)))

logh2s_10cv_ovp_plot_full <- ggplot(tibble(obs = obs_10cv_everything, pred = exp(pred_10cv_everything)),
                             aes(x = pred, y = obs)) +
                        geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +                                                         geom_point() +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq")), label.x = "right", label.y = 0.15) +                         stat_poly_eq(use_label(c("R2")), label.x = "right", label.y = 0.1) +                         stat_poly_eq(use_label(c("n")), label.x = "right", label.y = 0.05) +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Everything w.o Disaster Indicator') +
                        theme_bw()

validation_result_10cv <- rbind(validation_result_10cv, 
                           tibble(Model = 'SEverything w.o Disaster Indicator Log Transform',
                                  'Coef' = summary(lm(obs_10cv_everything ~
                                                        pred_10cv_everything))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(obs_10cv_everything ~
                                                        pred_10cv_everything))$r.squared))

validation_result_10cv
```

# XGBoost: log(H2S)
## Since Feb 2022
```{r}
validation_result <- tibble(Model = character(),
                            'Coef' = character(),
                            'R-Sq' = numeric(),
                            'Disaster RMSE' = numeric(),
                            'Normal RMSE' = numeric())

xgb_result <- tibble(Model = character(),
                 'XGB R-Sq' = numeric(),
                 'XGB BT R-Sq' = numeric(),
                 'XGB RMSE' = numeric(),
                 'XGB BT RMSE' = numeric()
                 )

train <- daily_avg_train_sincefeb2022 %>% 
  mutate(daily_downwind_ref = as.integer(daily_downwind_ref),
         daily_downwind_wrp = as.integer(daily_downwind_wrp)) %>%
  mutate(H2S_daily_avg = log(H2S_daily_avg))

train <- fastDummies::dummy_cols(train %>%
                   select(-c(day)) %>%
                   mutate(MinDist = 1/(MinDist^2),
                          dist_wrp = 1/(dist_wrp^2),
                          weekday = weekday),
                   remove_selected_columns = TRUE)

tune_grid <- expand.grid(nrounds = c(100, 200, 500),
                         max_depth = c(3, 4, 5),
                         eta = c(0.1, 0.3),
                         gamma = c(0.01, 0.001),
                         colsample_bytree = c(0.5, 1),
                         min_child_weight = 0,
                         subsample = c(0.5, 0.75, 1))

# Run algorithms using 10-fold cross validation
control <- trainControl(method="cv", 
                        number=10,
                        verboseIter=TRUE, 
                        search='grid',
                        savePredictions = 'final')

fit.xgb_da_log_h2s_sincefeb2022 <- readRDS('rfiles/fit.xgb_da_log_h2s_sincefeb2022.rds')
# fit.xgb_da_log_h2s_sincefeb2022 <- train(H2S_daily_avg~.,
#                  method = 'xgbTree',
#                  data = train,
#                  trControl=control,
#                  tuneGrid = tune_grid,
#                  tuneLength = 10, importance=TRUE, verbosity = 0, verbose=FALSE)
# saveRDS(fit.xgb_da_log_h2s_sincefeb2022, 'rfiles/fit.xgb_da_log_h2s_sincefeb2022.rds')
```

```{r}
getTrainPerf(fit.xgb_da_log_h2s_sincefeb2022)
```

```{r}
fit.xgb_da_log_h2s_sincefeb2022$finalModel
```

```{r}
names <- c("Longitude" = "mon_utm_x", "Latitude" = "mon_utm_y",
        "Distance to Refinery" = "MinDist", "Angle to Refinery" = "Converted_Angle",
        "Active Wells within 1km" = "active_1km", 
        "Monthly Oil Production 1km" = "monthly_oil_1km",
        "Monthly Gas Production 1km" = "monthly_gas_1km",
        "Distance to WRP" = "dist_wrp",
        "WRP Capacity" = "dist_wrp",
        "Angle to WRP" = "wrp_angle",
        "Distance to Dominguez Channel" = "dist_dc",
        "Average Daily Temperature" = "avg_temp",
        "Average Daily Humidity" = "avg_hum",
        "Daily Precipitation" = "precip",
        "Average Daily Wind Speed" = "ws_avg",
        "Average Daily Wind Direction" = "wd_avg",
        "Downwind Refinery" = "daily_downwind_ref",
        "Downwind WRP" = "daily_downwind_wrp",
        "Elevation" = "elevation",
        "Enhanced Vegetation Index" = "EVI",
        "Number of Daily Odor Complaints" = "num_odor_complaints",
        "Year 2022" = "year_2022",
        "Year 2023" = "year_2023",
        "January" = "month_01",
        "February" = "month_02",
        "March" = "month_03",
        "April" = "month_04",
        "May" = "month_05",
        "June" = "month_06", 
        "July" = "month_07",
        "August" = "month_08",
        "September" = "month_09",
        "October" = "month_10",
        "November" = "month_11",
        "December" = "month_12",
        "Monday" = "weekday_Mon",
        "Tuesday" = "weekday_Tue",
        "Wednesday" = "weekday_Wed",
        "Thursday" = "weekday_Thu",
        "Friday" = "weekday_Fri",
        "Saturday" = "weekday_Sat",
        "Sunday" = "weekday_Sun")

imp<-varImp(fit.xgb_da_log_h2s_sincefeb2022,scale=FALSE)

# rename variables
imp <- tibble(variable = rownames(imp$importance), importance = imp$importance$Overall) %>%
    pivot_wider(names_from = variable, 
                values_from = importance) %>%
    rename(any_of(names)) %>%
    pivot_longer(cols = everything(),names_to = 'variable', values_to = 'importance')

imp %>%
  top_n(15, importance) %>%
  ggplot(aes(x=reorder(variable, importance), y=importance)) + 
  geom_point() +
  geom_segment(aes(x=variable,xend=variable,y=0,yend=importance)) +
  ylab("importance") +
  xlab("Variable") +
  coord_flip() +
  theme_minimal()
```

### Fold Performance
```{r}
# Here, we compute the R2 and RMSE for each fold and take the average
fold_stat <- fit.xgb_da_log_h2s_sincefeb2022$pred %>% group_by(Resample) %>% 
  summarise(R2 = R2(pred, obs), RMSE = RMSE(pred, obs),
            R2_BT = R2(exp(pred), exp(obs)), RMSE_BT = RMSE(exp(pred), exp(obs)))
test_r2 <- mean(fold_stat$R2)
test_r2_bt <- mean(fold_stat$R2_BT)
test_rmse <- mean(fold_stat$RMSE)
test_rmse_bt <- mean(fold_stat$RMSE_BT)
```

```{r}
log_h2s_xgb_sincefeb2022_obs_vs_pred_plot <- ggplot(tibble(obs = exp(fit.xgb_da_log_h2s_sincefeb2022$pred$obs), 
                                                              pred = exp(fit.xgb_da_log_h2s_sincefeb2022$pred$pred)),
                             aes(x = pred, y = obs)) +
                        geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +                                                         geom_point() +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Since Februrary 2022') +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq")), label.x = "right", label.y = 0.05) +                                                stat_poly_eq(use_label(c("R2")), label.x = "right", label.y = 0.1) +                                                 stat_poly_eq(use_label(c("n")), label.x = "right", label.y = 0.15) +
                        theme_bw()
```

```{r}
validation_result <- rbind(validation_result, 
                           tibble(Model = 'Since Feb 2022 Log Transform',
                                  'Coef' = summary(lm(fit.xgb_da_log_h2s_sincefeb2022$pred$obs ~
                                                        fit.xgb_da_log_h2s_sincefeb2022$pred$pred))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(fit.xgb_da_log_h2s_sincefeb2022$pred$obs ~
                                                        fit.xgb_da_log_h2s_sincefeb2022$pred$pred))$r.squared))
```

### SHAP
```{r}
matrix <- train %>% select(-H2S_daily_avg)
matrix <- as.matrix(sapply(matrix, as.numeric))  
xgb.plot.shap(data = matrix, 
              model = fit.xgb_da_log_h2s_sincefeb2022$finalModel, top_n = 12, n_col = 3)
```


```{r}
xgb.ggplot.shap.summary(data = matrix, 
              model = fit.xgb_da_log_h2s_sincefeb2022$finalModel, top_n = 20)
```

```{r}
train_adj_r2 <- adj_r2(getTrainPerf(fit.xgb_da_log_h2s_sincefeb2022)$TrainRsquared, 
                       nrow(fit.xgb_da_log_h2s_sincefeb2022$trainingData), 
                       fit.xgb_da_log_h2s_sincefeb2022$finalModel$nfeatures)
BT_adj_r2 <- adj_r2(test_r2_bt,
                       nrow(fit.xgb_da_log_h2s_sincefeb2022$trainingData), 
                       fit.xgb_da_log_h2s_sincefeb2022$finalModel$nfeatures)

xgb_result <- rbind(xgb_result, 
                    tibble(Model = 'Since Feb 2022 Log Transform',
                           'XGB R-Sq' = train_adj_r2,
                           'XGB BT R-Sq' = BT_adj_r2,
                           'XGB RMSE' = test_rmse,
                           'XGB BT RMSE' = test_rmse_bt))
```

## Disaster Only
```{r}
train <- disaster %>% 
  mutate(daily_downwind_ref = as.integer(daily_downwind_ref),
         daily_downwind_wrp = as.integer(daily_downwind_wrp)) %>%
  mutate(H2S_daily_avg = log(H2S_daily_avg))

train <- fastDummies::dummy_cols(train %>%
                   select(-c(day)) %>%
                   mutate(MinDist = 1/(MinDist^2),
                          dist_wrp = 1/(dist_wrp^2),
                          weekday = weekday),
                   remove_selected_columns = TRUE)

fit.xgb_da_log_h2s_dis <- readRDS('rfiles/fit.xgb_da_log_h2s_dis.rds')
# fit.xgb_da_log_h2s_dis <- train(H2S_daily_avg~.,
#                  method = 'xgbTree',
#                  data = train,
#                  trControl=control,
#                  tuneGrid = tune_grid,
#                  tuneLength = 10, importance=TRUE, verbosity = 0, verbose=FALSE)
# saveRDS(fit.xgb_da_log_h2s_dis, 'rfiles/fit.xgb_da_log_h2s_dis.rds')
```

```{r}
getTrainPerf(fit.xgb_da_log_h2s_dis)
```

```{r}
fit.xgb_da_log_h2s_dis$finalModel
```

```{r}
imp<-varImp(fit.xgb_da_log_h2s_dis,scale=FALSE)

# rename variables
imp <- tibble(variable = rownames(imp$importance), importance = imp$importance$Overall) %>%
    pivot_wider(names_from = variable, 
                values_from = importance) %>%
    rename(any_of(names)) %>%
    pivot_longer(cols = everything(),names_to = 'variable', values_to = 'importance')

imp %>%
  top_n(15, importance) %>%
  ggplot(aes(x=reorder(variable, importance), y=importance)) + 
  geom_point() +
  geom_segment(aes(x=variable,xend=variable,y=0,yend=importance)) +
  ylab("importance") +
  xlab("Variable") +
  coord_flip() +
  theme_minimal()
```

### Fold Performance
```{r}
# Here, we compute the R2 and RMSE for each fold and take the average
fold_stat <- fit.xgb_da_log_h2s_dis$pred %>% group_by(Resample) %>% 
  summarise(R2 = R2(pred, obs), RMSE = RMSE(pred, obs),
            R2_BT = R2(exp(pred), exp(obs)), RMSE_BT = RMSE(exp(pred), exp(obs)))
test_r2 <- mean(fold_stat$R2)
test_r2_bt <- mean(fold_stat$R2_BT)
test_rmse <- mean(fold_stat$RMSE)
test_rmse_bt <- mean(fold_stat$RMSE_BT)
```

```{r}
log_h2s_xgb_dis_obs_vs_pred_plot <- ggplot(tibble(obs = exp(fit.xgb_da_log_h2s_dis$pred$obs), 
                                                              pred = exp(fit.xgb_da_log_h2s_dis$pred$pred)),
                             aes(x = pred, y = obs)) +
                        geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +                                                         geom_point() +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Disaster Only') +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq")), label.x = "right", label.y = 0.03) +                                                stat_poly_eq(use_label(c("R2")), label.x = "right", label.y = 0.1) +                                                 stat_poly_eq(use_label(c("n")), label.x = "right", label.y = 0.18) +
                        theme_bw()
```

```{r}
validation_result <- rbind(validation_result, 
                           tibble(Model = 'Disaster Only Log Transform',
                                  'Coef' = summary(lm(fit.xgb_da_log_h2s_dis$pred$obs ~
                                                        fit.xgb_da_log_h2s_dis$pred$pred))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(fit.xgb_da_log_h2s_dis$pred$obs ~
                                                        fit.xgb_da_log_h2s_dis$pred$pred))$r.squared))
```

### SHAP
```{r}
matrix <- train %>% select(-H2S_daily_avg)
matrix <- as.matrix(sapply(matrix, as.numeric))
xgb.plot.shap(data = matrix, 
              model = fit.xgb_da_log_h2s_dis$finalModel, top_n = 12, n_col = 3)
```


```{r}
xgb.ggplot.shap.summary(data = matrix, 
              model = fit.xgb_da_log_h2s_dis$finalModel, top_n = 20)
```

```{r}
train_adj_r2 <- adj_r2(getTrainPerf(fit.xgb_da_log_h2s_dis)$TrainRsquared, 
                       nrow(fit.xgb_da_log_h2s_dis$trainingData), 
                       fit.xgb_da_log_h2s_dis$finalModel$nfeatures)
BT_adj_r2 <- adj_r2(test_r2_bt,
                       nrow(fit.xgb_da_log_h2s_dis$trainingData), 
                       fit.xgb_da_log_h2s_dis$finalModel$nfeatures)

xgb_result <- rbind(xgb_result, 
                    tibble(Model = 'Disaster Only Log Transform',
                           'XGB R-Sq' = train_adj_r2,
                           'XGB BT R-Sq' = BT_adj_r2,
                           'XGB RMSE' = test_rmse,
                           'XGB BT RMSE' = test_rmse_bt))
```


## Exclude Disaster
```{r}
train <- excl_disaster %>% 
  mutate(daily_downwind_ref = as.integer(daily_downwind_ref),
         daily_downwind_wrp = as.integer(daily_downwind_wrp)) %>%
  mutate(H2S_daily_avg = log(H2S_daily_avg))

train <- fastDummies::dummy_cols(train %>%
                   select(-c(day)) %>%
                   mutate(MinDist = 1/(MinDist^2),
                          dist_wrp = 1/(dist_wrp^2),
                          weekday = weekday),
                   remove_selected_columns = TRUE)

fit.xgb_da_log_h2s_excl_dis <- readRDS('rfiles/fit.xgb_da_log_h2s_excl_dis.rds')
# fit.xgb_da_log_h2s_excl_dis <- train(H2S_daily_avg~.,
#                  method = 'xgbTree',
#                  data = train,
#                  trControl=control,
#                  tuneGrid = tune_grid,
#                  tuneLength = 10, importance=TRUE, verbosity = 0, verbose=FALSE)
# saveRDS(fit.xgb_da_log_h2s_excl_dis, 'rfiles/fit.xgb_da_log_h2s_excl_dis.rds')
```

```{r}
getTrainPerf(fit.xgb_da_log_h2s_excl_dis)
```

```{r}
fit.xgb_da_log_h2s_excl_dis$finalModel
```

```{r}
imp<-varImp(fit.xgb_da_log_h2s_excl_dis,scale=FALSE)

# rename variables
imp <- tibble(variable = rownames(imp$importance), importance = imp$importance$Overall) %>%
    pivot_wider(names_from = variable, 
                values_from = importance) %>%
    rename(any_of(names)) %>%
    pivot_longer(cols = everything(),names_to = 'variable', values_to = 'importance')

imp %>%
  top_n(15, importance) %>%
  ggplot(aes(x=reorder(variable, importance), y=importance)) + 
  geom_point() +
  geom_segment(aes(x=variable,xend=variable,y=0,yend=importance)) +
  ylab("importance") +
  xlab("Variable") +
  coord_flip() +
  theme_minimal()
```

### Fold Performance
```{r}
# Here, we compute the R2 and RMSE for each fold and take the average
fold_stat <- fit.xgb_da_log_h2s_excl_dis$pred %>% group_by(Resample) %>% 
  summarise(R2 = R2(pred, obs), RMSE = RMSE(pred, obs),
            R2_BT = R2(exp(pred), exp(obs)), RMSE_BT = RMSE(exp(pred), exp(obs)))
test_r2 <- mean(fold_stat$R2)
test_r2_bt <- mean(fold_stat$R2_BT)
test_rmse <- mean(fold_stat$RMSE)
test_rmse_bt <- mean(fold_stat$RMSE_BT)
```

```{r}
log_h2s_xgb_excl_dis_obs_vs_pred_plot <- ggplot(tibble(obs = exp(fit.xgb_da_log_h2s_excl_dis$pred$obs), 
                                                              pred = exp(fit.xgb_da_log_h2s_excl_dis$pred$pred)),
                             aes(x = pred, y = obs)) +
                        geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +                                                         geom_point() +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Exclude Disaster') +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq")), label.x = "right", label.y = 0.15) +                                                stat_poly_eq(use_label(c("R2")), label.x = "right", label.y = 0.1) +                                                 stat_poly_eq(use_label(c("n")), label.x = "right", label.y = 0.05) +
                        theme_bw()
```

```{r}
validation_result <- rbind(validation_result, 
                           tibble(Model = 'Exclude Disaster Log Transform',
                                  'Coef' = summary(lm(fit.xgb_da_log_h2s_excl_dis$pred$obs ~
                                                        fit.xgb_da_log_h2s_excl_dis$pred$pred))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(fit.xgb_da_log_h2s_excl_dis$pred$obs ~
                                                        fit.xgb_da_log_h2s_excl_dis$pred$pred))$r.squared))
```

### SHAP
```{r}
matrix <- train %>% select(-H2S_daily_avg)
matrix <- as.matrix(sapply(matrix, as.numeric))
xgb.plot.shap(data = matrix, 
              model = fit.xgb_da_log_h2s_excl_dis$finalModel, top_n = 12, n_col = 3)
```


```{r}
xgb.ggplot.shap.summary(data = matrix, 
              model = fit.xgb_da_log_h2s_excl_dis$finalModel, top_n = 20)
```

```{r}
train_adj_r2 <- adj_r2(getTrainPerf(fit.xgb_da_log_h2s_excl_dis)$TrainRsquared, 
                       nrow(fit.xgb_da_log_h2s_excl_dis$trainingData), 
                       fit.xgb_da_log_h2s_excl_dis$finalModel$nfeatures)
BT_adj_r2 <- adj_r2(test_r2_bt,
                       nrow(fit.xgb_da_log_h2s_excl_dis$trainingData), 
                       fit.xgb_da_log_h2s_excl_dis$finalModel$nfeatures)

xgb_result <- rbind(xgb_result, 
                    tibble(Model = 'Exclude Disaster Log Transform',
                           'XGB R-Sq' = train_adj_r2,
                           'XGB BT R-Sq' = BT_adj_r2,
                           'XGB RMSE' = test_rmse,
                           'XGB BT RMSE' = test_rmse_bt))
```

## Everything w. Disaster Indicator
```{r}
train <- everything %>% 
  mutate(daily_downwind_ref = as.integer(daily_downwind_ref),
         daily_downwind_wrp = as.integer(daily_downwind_wrp)) %>%
  mutate(H2S_daily_avg = log(H2S_daily_avg))

train <- fastDummies::dummy_cols(train %>%
                   select(-c(day)) %>%
                   mutate(MinDist = 1/(MinDist^2),
                          dist_wrp = 1/(dist_wrp^2),
                          weekday = weekday),
                   remove_selected_columns = TRUE)

fit.xgb_da_log_h2s_dis_ind <- readRDS('rfiles/fit.xgb_da_log_h2s_dis_ind.rds')
# fit.xgb_da_log_h2s_dis_ind <- train(H2S_daily_avg~.,
#                  method = 'xgbTree',
#                  data = train,
#                  trControl=control,
#                  tuneGrid = tune_grid,
#                  tuneLength = 10, importance=TRUE, verbosity = 0, verbose=FALSE)
# saveRDS(fit.xgb_da_log_h2s_dis_ind, 'rfiles/fit.xgb_da_log_h2s_dis_ind.rds')
```

```{r}
getTrainPerf(fit.xgb_da_log_h2s_dis_ind)
```

```{r}
fit.xgb_da_log_h2s_dis_ind$finalModel
```

```{r}
imp<-varImp(fit.xgb_da_log_h2s_dis_ind,scale=FALSE)

# rename variables
imp <- tibble(variable = rownames(imp$importance), importance = imp$importance$Overall) %>%
    pivot_wider(names_from = variable, 
                values_from = importance) %>%
    rename(any_of(names)) %>%
    pivot_longer(cols = everything(),names_to = 'variable', values_to = 'importance')

imp %>%
  top_n(15, importance) %>%
  ggplot(aes(x=reorder(variable, importance), y=importance)) + 
  geom_point() +
  geom_segment(aes(x=variable,xend=variable,y=0,yend=importance)) +
  ylab("importance") +
  xlab("Variable") +
  coord_flip() +
  theme_minimal()
```

### Fold Performance
```{r}
# Here, we compute the R2 and RMSE for each fold and take the average
fold_stat <- fit.xgb_da_log_h2s_dis_ind$pred %>% group_by(Resample) %>% 
  summarise(R2 = R2(pred, obs), RMSE = RMSE(pred, obs),
            R2_BT = R2(exp(pred), exp(obs)), RMSE_BT = RMSE(exp(pred), exp(obs)))
test_r2 <- mean(fold_stat$R2)
test_r2_bt <- mean(fold_stat$R2_BT)
test_rmse <- mean(fold_stat$RMSE)
test_rmse_bt <- mean(fold_stat$RMSE_BT)
```

```{r}
log_h2s_xgb_dis_ind_obs_vs_pred_plot <- ggplot(tibble(obs = exp(fit.xgb_da_log_h2s_dis_ind$pred$obs), 
                                                              pred = exp(fit.xgb_da_log_h2s_dis_ind$pred$pred)),
                             aes(x = pred, y = obs)) +
                        geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +                                                         geom_point() +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Everything w. Disaster Indicator') +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq")), label.x = "right", label.y = 0.03) +                                                stat_poly_eq(use_label(c("R2")), label.x = "right", label.y = 0.08) +                                                 stat_poly_eq(use_label(c("n")), label.x = "right", label.y = 0.17) +
                        theme_bw()
```

```{r}
validation_result <- rbind(validation_result, 
                           tibble(Model = 'Everything w. Disaster Indicator Log Transform',
                                  'Coef' = summary(lm(fit.xgb_da_log_h2s_dis_ind$pred$obs ~
                                                        fit.xgb_da_log_h2s_dis_ind$pred$pred))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(fit.xgb_da_log_h2s_dis_ind$pred$obs ~
                                                        fit.xgb_da_log_h2s_dis_ind$pred$pred))$r.squared))
```

### SHAP
```{r}
matrix <- train %>% select(-H2S_daily_avg)
matrix <- as.matrix(sapply(matrix, as.numeric))
xgb.plot.shap(data = matrix, 
              model = fit.xgb_da_log_h2s_dis_ind$finalModel, top_n = 12, n_col = 3)
```


```{r}
xgb.ggplot.shap.summary(data = matrix, 
              model = fit.xgb_da_log_h2s_dis_ind$finalModel, top_n = 20)
```

```{r}
train_adj_r2 <- adj_r2(getTrainPerf(fit.xgb_da_log_h2s_dis_ind)$TrainRsquared, 
                       nrow(fit.xgb_da_log_h2s_dis_ind$trainingData), 
                       fit.xgb_da_log_h2s_dis_ind$finalModel$nfeatures)
BT_adj_r2 <- adj_r2(test_r2_bt,
                       nrow(fit.xgb_da_log_h2s_dis_ind$trainingData), 
                       fit.xgb_da_log_h2s_dis_ind$finalModel$nfeatures)

xgb_result <- rbind(xgb_result, 
                    tibble(Model = 'Everything w. Disaster Indicator Log Transform',
                           'XGB R-Sq' = train_adj_r2,
                           'XGB BT R-Sq' = BT_adj_r2,
                           'XGB RMSE' = test_rmse,
                           'XGB BT RMSE' = test_rmse_bt))
```

## Everything w.o Disaster Indicator
```{r}
train <- everything %>% 
  select(-disaster) %>%
  mutate(daily_downwind_ref = as.integer(daily_downwind_ref),
         daily_downwind_wrp = as.integer(daily_downwind_wrp)) %>%
  mutate(H2S_daily_avg = log(H2S_daily_avg))

train <- fastDummies::dummy_cols(train %>%
                   select(-c(day)) %>%
                   mutate(MinDist = 1/(MinDist^2),
                          dist_wrp = 1/(dist_wrp^2),
                          weekday = weekday),
                   remove_selected_columns = TRUE)

fit.xgb_da_log_h2s_full <- readRDS('rfiles/fit.xgb_da_log_h2s_full.rds')
# fit.xgb_da_log_h2s_full <- train(H2S_daily_avg~.,
#                  method = 'xgbTree',
#                  data = train,
#                  trControl=control,
#                  tuneGrid = tune_grid,
#                  tuneLength = 10, importance=TRUE, verbosity = 0, verbose=FALSE)
# saveRDS(fit.xgb_da_log_h2s_full, 'rfiles/fit.xgb_da_log_h2s_full.rds')
```

```{r}
getTrainPerf(fit.xgb_da_log_h2s_full)
```

```{r}
fit.xgb_da_log_h2s_full$finalModel
```

```{r}
imp<-varImp(fit.xgb_da_log_h2s_full,scale=FALSE)

# rename variables
imp <- tibble(variable = rownames(imp$importance), importance = imp$importance$Overall) %>%
    pivot_wider(names_from = variable, 
                values_from = importance) %>%
    rename(any_of(names)) %>%
    pivot_longer(cols = everything(),names_to = 'variable', values_to = 'importance')

imp %>%
  top_n(15, importance) %>%
  ggplot(aes(x=reorder(variable, importance), y=importance)) + 
  geom_point() +
  geom_segment(aes(x=variable,xend=variable,y=0,yend=importance)) +
  ylab("importance") +
  xlab("Variable") +
  coord_flip() +
  theme_minimal()
```

### Fold Performance
```{r}
# Here, we compute the R2 and RMSE for each fold and take the average
fold_stat <- fit.xgb_da_log_h2s_full$pred %>% group_by(Resample) %>% 
  summarise(R2 = R2(pred, obs), RMSE = RMSE(pred, obs),
            R2_BT = R2(exp(pred), exp(obs)), RMSE_BT = RMSE(exp(pred), exp(obs)))
test_r2 <- mean(fold_stat$R2)
test_r2_bt <- mean(fold_stat$R2_BT)
test_rmse <- mean(fold_stat$RMSE)
test_rmse_bt <- mean(fold_stat$RMSE_BT)
```

```{r}
log_h2s_xgb_full_obs_vs_pred_plot <- ggplot(tibble(obs = exp(fit.xgb_da_log_h2s_full$pred$obs), 
                                                              pred = exp(fit.xgb_da_log_h2s_full$pred$pred)),
                             aes(x = pred, y = obs)) +
                        geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +                                                         geom_point() +
                        labs(y = 'Observed', x = 'Predicted', 
                             title = 'Everything w.o Disaster Indicator') +
                        stat_poly_line() +
                        stat_poly_eq(use_label(c("eq")), label.x = "right", label.y = 0.15) +                                                stat_poly_eq(use_label(c("R2")), label.x = "right", label.y = 0.1) +                                                 stat_poly_eq(use_label(c("n")), label.x = "right", label.y = 0.05) +
                        theme_bw()
```

```{r}
validation_result <- rbind(validation_result, 
                           tibble(Model = 'Everything w.o Disaster Indicator Log Transform',
                                  'Coef' = summary(lm(fit.xgb_da_log_h2s_full$pred$obs ~
                                                        fit.xgb_da_log_h2s_full$pred$pred))$coefficients[2, 1], 
                                  'R-Sq' = summary(lm(fit.xgb_da_log_h2s_full$pred$obs ~
                                                        fit.xgb_da_log_h2s_full$pred$pred))$r.squared))
```

### SHAP
```{r}
matrix <- train %>% select(-H2S_daily_avg)
matrix <- as.matrix(sapply(matrix, as.numeric)) 
xgb.plot.shap(data = matrix, 
              model = fit.xgb_da_log_h2s_full$finalModel, top_n = 12, n_col = 3)
```


```{r}
xgb.ggplot.shap.summary(data = matrix, 
              model = fit.xgb_da_log_h2s_full$finalModel, top_n = 20)
```

```{r}
train_adj_r2 <- adj_r2(getTrainPerf(fit.xgb_da_log_h2s_full)$TrainRsquared, 
                       nrow(fit.xgb_da_log_h2s_full$trainingData), 
                       fit.xgb_da_log_h2s_full$finalModel$nfeatures)
BT_adj_r2 <- adj_r2(test_r2_bt, 
                       nrow(fit.xgb_da_log_h2s_full$trainingData), 
                       fit.xgb_da_log_h2s_full$finalModel$nfeatures)

xgb_result <- rbind(xgb_result, 
                    tibble(Model = 'Everything w.o Disaster Indicator Log Transform',
                           'XGB R-Sq' = train_adj_r2,
                           'XGB BT R-Sq' = BT_adj_r2,
                           'XGB RMSE' = test_rmse,
                           'XGB BT RMSE' = test_rmse_bt))
```

# Result Comparison
# Comparison
```{r}
log_model_perf_table <- tibble(Model = c('Since Feb 2022 Log Transform',
                              'Disaster Only Log Transform',
                              'Exclude Disaster Log Transform',
                              'Everything w. Disaster Indicator Log Transform',
                              'Everything w.o Disaster Indicator Log Transform'),
                    n = c(nrow(fit.xgb_da_log_h2s_sincefeb2022$trainingData),
                          nrow(fit.xgb_da_log_h2s_dis$trainingData),
                          nrow(fit.xgb_da_log_h2s_excl_dis$trainingData),
                          nrow(fit.xgb_da_log_h2s_dis_ind$trainingData),
                          nrow(fit.xgb_da_log_h2s_full$trainingData))) %>% 
               left_join(rbind(result_10cv)) %>%
               left_join(rbind(xgb_result))

log_model_perf_latex <- knitr::kable(log_model_perf_table, digits = 3, format = 'latex')
writeLines(log_model_perf_latex, 'figures/log_model_perf.tex')

knitr::kable(log_model_perf_table, digits = 3, format = 'html')
```

```{r}
# Gam Models
ggarrange(logh2s_10cv_ovp_plot_sincefeb2022, 
          logh2s_10cv_ovp_plot_dis_only,
          logh2s_10cv_ovp_plot_excl_dis,
          labels = c("1", "2", "3"),
          nrow = 3)

ggarrange(logh2s_10cv_ovp_plot_dis_ind,
          logh2s_10cv_ovp_plot_full,
          labels = c("4", "5"),
          nrow = 2)
```

```{r}
ggarrange(log_h2s_xgb_sincefeb2022_obs_vs_pred_plot, 
          log_h2s_xgb_dis_obs_vs_pred_plot,
          log_h2s_xgb_excl_dis_obs_vs_pred_plot, 
          labels = c("1", "2", "3"),
          nrow = 3)
ggarrange(log_h2s_xgb_dis_ind_obs_vs_pred_plot, 
          log_h2s_xgb_full_obs_vs_pred_plot,
          labels = c("4", "5"),
          nrow = 2)
```

# For Figures
```{r}
ggarrange(logh2s_10cv_ovp_plot_sincefeb2022 + labs(title = 'GAM'),
          log_h2s_xgb_sincefeb2022_obs_vs_pred_plot + labs(title = 'XGBoost'),
          nrow = 1)
```

```{r}
ggarrange(log_h2s_xgb_dis_obs_vs_pred_plot + labs(title = ''),
          log_h2s_xgb_dis_obs_vs_pred_plot + 
            labs(title = '') + 
            coord_cartesian(xlim = c(0, 15), ylim = c(0, 15)),
          nrow = 1)
```

```{r}
ggarrange(log_h2s_xgb_dis_ind_obs_vs_pred_plot + labs(title = ''),
          log_h2s_xgb_dis_ind_obs_vs_pred_plot + 
            labs(title = '') + 
            coord_cartesian(xlim = c(0, 15), ylim = c(0, 15)),
          nrow = 1)
```

