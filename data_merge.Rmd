---
title: "Merge LA refinery data ses"
author: "Jerry Wu"
date: "5/1/2023"
output:
  html_document:
    df_print: paged
abstract: ''
subtitle: ''
---

```{r setup, include=FALSE}
library(tidyverse)
library(mgcv)
```

```{r}
# load data sets
full_data <- tibble()
names <- c(ws = 'windSpeed', wd = 'windDirection', H2S = 'Value')
for (file in list.files('data/raw_csv')){
  new_data <- read.csv(paste0('data/raw_csv/', file)) %>% rename(any_of(names))
  print(sum(is.na(new_data$H2S)))
  full_data <- bind_rows(full_data, new_data)
}
```

```{r}
full_data <- full_data %>% mutate(DateTime = as.POSIXct(DateTime, format="%m/%d/%Y %H:%M", tz = 'UTC'),
                                  Date.Time = as.POSIXct(Date.Time, format="%m/%d/%Y %H:%M", tz = 'UTC'),
                                  Date.Time.First = as.POSIXct(Date.Time.First, format="%m/%d/%Y %H:%M", tz = 'UTC'))
full_data <- full_data %>% 
  mutate(day = format(DateTime, "%Y-%m-%d")) %>%
  mutate(day = if_else(is.na(day), format(Date.Time, "%Y-%m-%d"), day)) %>%
  mutate(day = if_else(is.na(day), format(Date.Time.First, "%Y-%m-%d"), day)) %>%
  mutate(day = as.POSIXct(day, format="%Y-%m-%d")) %>%
  mutate(yearmonth = format(day, "%Y-%m")) %>%
  mutate(year = format(day, "%Y")) %>%
  mutate(month = format(day, "%m"))
```

```{r}
glimpse(full_data)
```

```{r}
summary(full_data)
```
Some concerns for the data include:
For TorranceAir_H2SWind, there are actually three sites, but only one site contains ws/wd information
What's the difference between DateTime and Date/Time?
What's the difference between Date/Time and Date/Time.First? The latter is present in FirstMethodist

# Compute Daily Max H2S
```{r}
H2S_dm <- full_data %>%
  group_by(day, Monitor) %>%
  summarise(H2S_daily_max = max(H2S, na.rm = TRUE)) %>%
  mutate(H2S_daily_max = if_else(H2S_daily_max == -Inf, NA, H2S_daily_max))

full_data <- full_data %>%
  left_join(H2S_dm, by = c('day', 'Monitor'))
```

```{r}
H2S_ma <- H2S_dm %>%
  mutate(yearmonth = format(day, "%Y-%m")) %>%
  group_by(yearmonth, Monitor) %>%
  summarise(H2S_monthly_average = mean(H2S_daily_max, na.rm = TRUE))

full_data <- full_data %>%
  left_join(H2S_ma, by = c('yearmonth', 'Monitor'))
```


```{r}
H2S_dm %>%
 ggplot(aes(x=day, y=H2S_daily_max, group=Monitor, color=Monitor)) +
   geom_line() +
   labs(title = "Daily Max H2S concentration by monitor", y = 'Daily Max H2S', x = 'time') +
   theme_minimal() +
   theme(axis.text.x = element_text(angle = 45))
```

```{r}

H2S_ma %>%
 ggplot(aes(x=yearmonth, y=H2S_monthly_average, group=Monitor, color=Monitor)) +
   geom_line() +
   labs(title = "Monthly Average H2S concentration by monitor", y = 'Monthly Average H2S', x = 'time') +
   scale_x_discrete(breaks = unique(H2S_ma$yearmonth)[seq(1, length(unique(H2S_ma$yearmonth)), by = 6)]) +
   theme_minimal() +
   theme(axis.text.x = element_text(angle = 45))

```
The line with the largest deviation/peak corresponds to the 213th&Chico monitor, in 2021-10

```{r}
library(openair)
full_data %>%
  polarPlot(pollutant = "H2S", col = "turbo", 
            key.position = "bottom",
            key.header = "mean H2S", 
            key.footer = NULL)
```
```{r}
full_data <- full_data %>%
  mutate(wd_sec = case_when(0 <= wd & wd < 90 ~ 'Q1',
                            90 <= wd & wd < 180 ~ 'Q2',
                            180 <= wd & wd < 270 ~ 'Q3',
                            270 <= wd & wd <= 360 ~ 'Q4'))
```


```{r}
h2s_model_a <- gam(H2S~s(as.numeric(month),bs='cc')+year+wd_sec+ws+MinDist+Refinery, data = full_data)
summary(h2s_model_a)
plot(h2s_model_a)
```
```{r}
h2s_dm_model_a <- gam(H2S_daily_max~s(as.numeric(month),bs='cc')+year+wd_sec+ws+MinDist+Refinery, data = full_data)
summary(h2s_dm_model_a)
plot(h2s_dm_model_a)
```

```{r}
h2s_ma_model_a <- gam(H2S_monthly_average~s(as.numeric(month),bs='cc')+year+wd_sec+ws+MinDist+Refinery, data = full_data)
summary(h2s_ma_model_a)
plot(h2s_ma_model_a)
```

```{r}
saveRDS(full_data, 'data/full_data.rds')
```

