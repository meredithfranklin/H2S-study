---
title: "Zipcode prediction"
author: "Jerry Wu"
date: "2024-03-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(httr)
library(jsonlite)
library(sf)
select <- dplyr::select
```

# Load in data
```{r}
zipcode_grid_df <- read_csv('zipcode_grid_df.csv')
zipcode_fetched <- readRDS('zipcode_grid_fetched_weather.rds')
```

```{r}
# Code to fetch weather data
# For first time
#zipcode_grid_fetched_home <- tibble(lon = numeric(), lat = numeric())

zipcode_daily_unfetched_result <- zipcode_grid_df %>%
  anti_join(zipcode_fetched, join_by(lon == longitude, lat == latitude))

zipcode_daily_result <- tibble(latitude = numeric(),
                               longitude = numeric(),
                               day = numeric(),
                               daily_temp = numeric(),
                               daily_hum = numeric(),
                               daily_precip = numeric(),
                               daily_ws = numeric(),
                               daily_wd = numeric())

hourly_result <- tibble(latitude = numeric(),
                 longitude = numeric(),
                 hourly = numeric(),
                 hourly_temp = numeric(),
                 hourly_hum = numeric(),
                 hourly_precip = numeric(),
                 hourly_ws = numeric(),
                 hourly_wd = numeric())

# loop through rows
for (i in 1:nrow(zipcode_daily_unfetched_result)){

  get_url <- sprintf("https://customer-archive-api.open-meteo.com/v1/archive?latitude=%s&longitude=%s&start_date=2018-01-01&end_date=2022-12-31&hourly=temperature_2m,relative_humidity_2m,precipitation,wind_speed_10m,wind_direction_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=America%%2FLos_Angeles&apikey=S4sRENjfQvm2aH86",
                     zipcode_daily_unfetched_result$lat[i], zipcode_daily_unfetched_result$lon[i])
  res = GET(get_url)
  data = fromJSON(rawToChar(res$content))
  if (!(is.null(try(data$error)))){
    ith_daily_result <- tibble(latitude = zipcode_daily_unfetched_result$lat[i],
                                        longitude = zipcode_daily_unfetched_result$lon[i],
                                        day = NA,
                                        daily_temp = NA,
                                        daily_hum = NA,
                                        daily_precip = NA,
                                        daily_ws = NA,
                                        daily_wd = NA)
  }
  else {
    hourly_result <- tibble(latitude = zipcode_daily_unfetched_result$lat[i],
                                        longitude = zipcode_daily_unfetched_result$lon[i],
                            elevation = data$elevation,
                            hourly = data$hourly$time,
                            hourly_temp = data$hourly$temperature_2m,
                            hourly_hum = data$hourly$relative_humidity_2m,
                            hourly_precip = data$hourly$precipitation,
                            hourly_ws = data$hourly$wind_speed_10m,
                            hourly_wd = data$hourly$wind_direction_10m)
    
    ith_daily_result <- hourly_result %>%
      mutate(date = as.POSIXct(hourly)) %>%
      mutate(day = format(date, "%Y-%m-%d"))
    
    ith_daily_result$hourly_wd <- as.numeric(ith_daily_result$hourly_wd)

    ith_daily_result <- ith_daily_result %>%
      group_by(latitude, longitude, day) %>%
      summarise(daily_temp = mean(hourly_temp, na.rm = T),
                daily_hum = mean(hourly_hum, na.rm = T),
                daily_precip = sum(hourly_precip, na.rm = T),
                daily_ws = mean(hourly_ws, na.rm = T),
                daily_wd = as.numeric(mean(circular(hourly_wd, units = 'degrees'), na.rm=TRUE)),
                .groups = 'drop')
    
    ith_daily_result <- ith_daily_result %>%
      mutate(daily_wd = if_else(daily_wd < 0, daily_wd + 360, daily_wd))
  }

  zipcode_daily_result <- rbind(zipcode_daily_result, ith_daily_result)
  
  print(sprintf("Row %s completed", i))
}

zipcode_daily_result <- rbind(zipcode_fetched, zipcode_daily_result)
saveRDS(zipcode_daily_result, 'zipcode_grid_fetched_weather.rds')
```

